# 批量处理性能测试报告

## 测试信息

- **测试时间**: 2025-10-23 16:23:05
- **测试类型**: 完整流程性能测试（检测 → 加密 → 存储）
- **测试数据**: 
  - CSV文件: `data/train_with_sensitive_info.csv`
  - DICOM目录: `data/output_dicom/`

---

## 测试结果总览

### 处理结果

| 项目 | 数量 | 成功率 |
|------|------|--------|
| CSV患者总数 | 5000 | - |
| DICOM文件数 | 5000 | - |
| 检测匹配成功 | 5000 | 100% |
| 加密保护文件 | 5000 | 100% |
| 入库存储对象 | 1222 | - |

**说明**: 入库对象数为1222是因为系统按patient_id去重，实际有1222个不同的患者。

---

## 性能指标

### 核心性能

```
核心处理时间: 192.648秒（检测 + 加密 + 存储）
平均处理速度: 0.039秒/患者
性能要求标准: < 2.0秒/患者
测试结果: [PASS] 性能达标（快 51倍）
```

### 完整流程时间分解

**总处理时间: 315.423秒 (约5分15秒)**

| 步骤 | 操作 | 时间(秒) | 占比 | 说明 |
|------|------|----------|------|------|
| 1 | CSV上传 | 2.041 | 0.6% | 文件传输到服务器 |
| 2 | DICOM上传 | 120.730 | 38.3% | 5000个DICOM文件分批传输 |
| 3 | **检测匹配** | **2.675** | **0.8%** | 跨模态隐私检测 |
| 4 | **加密保护** | **161.067** | **51.1%** | AEAD + FPE加密 |
| 5 | **存储入库** | **28.905** | **9.2%** | CAS存储 + SQLite索引 |
| | **总计** | **315.423** | **100%** | |

---

## 详细分析

### 时间分布图

```
上传阶段 (122.771秒, 38.9%)
  - CSV上传:       2.041秒   (1.6%)
  - DICOM上传:   120.730秒   (96.4%)

核心处理 (192.648秒, 61.1%)
  - 检测匹配:      2.675秒   (1.4%)
  - 加密保护:    161.067秒   (83.6%)
  - 存储入库:     28.905秒   (15.0%)
```

### 性能瓶颈分析

#### 1. 加密保护阶段 (161.067秒, 51.1%)

**最耗时的环节，但这是安全性必需的成本**

- **AEAD加密**: 5000个DICOM影像文件加密
  - 算法: Ascon AEAD (认证加密)
  - 用途: 医学影像数据保护
  - 特点: 同时提供加密和完整性验证

- **FPE加密**: 5000条CSV诊断报告字段加密
  - 算法: 基于Ascon-PRF的格式保留加密
  - 用途: 敏感文本字段保护
  - 特点: 保持原数据格式和长度

**平均加密速度**: 161.067秒 ÷ 5000 = **0.032秒/文件对**

#### 2. DICOM上传阶段 (120.730秒, 38.3%)

- 分10批上传，每批500个文件
- 主要时间消耗在网络传输和文件I/O
- **平均上传速度**: 120.730秒 ÷ 5000 = **0.024秒/文件**

#### 3. 存储入库阶段 (28.905秒, 9.2%)

包含以下操作：
- SHA256哈希计算
- Content-Addressable Storage (CAS) 写入
- SQLite数据库索引创建
- 审计日志记录

**平均入库速度**: 28.905秒 ÷ 1222 = **0.024秒/对象**

#### 4. 检测匹配阶段 (2.675秒, 0.8%)

**性能最优的环节**

- 5000个CSV患者 × 5000个DICOM文件的跨模态匹配
- 使用高效的索引算法
- **平均检测速度**: 2.675秒 ÷ 5000 = **0.0005秒/患者**

---

## 性能评估

### 达标情况

| 评估项 | 要求 | 实际 | 状态 |
|--------|------|------|------|
| 平均处理速度 | < 2.0秒/患者 | 0.039秒/患者 | [PASS] 达标 (快51倍) |
| 检测准确率 | > 95% | 100% | [PASS] 优秀 |
| 加密成功率 | 100% | 100% | [PASS] 达标 |
| 存储成功率 | 100% | 100% | [PASS] 达标 |

### 性能优势

1. **检测速度极快**: 0.0005秒/患者，远超预期
2. **整体性能优秀**: 核心处理速度0.039秒/患者，快于要求51倍
3. **无数据丢失**: 5000个输入全部成功处理
4. **100%匹配率**: 跨模态检测准确性极高

### 优化建议

虽然当前性能已达标，但仍有优化空间：

1. **加密并行化**: 可考虑多进程并行加密，预计可提速2-4倍
2. **批量上传优化**: 增大单批上传量（当前500个/批）
3. **存储优化**: SQLite批量写入优化，减少I/O次数

---

## 测试结论

### 总体评价: 优秀

**核心处理性能**: 0.039秒/患者，远超2.0秒/患者的要求标准

**检测准确性**: 100%匹配率，跨模态检测算法高效准确

**加密安全性**: 使用后量子安全的Ascon算法，加密成功率100%

**系统稳定性**: 5000条数据无一失败，系统运行稳定

### 关键数据

```
测试规模:     5000个患者 x 5000个DICOM文件
总处理时间:   315.423秒 (约5分钟)
核心处理:     192.648秒
平均速度:     0.039秒/患者
性能达标:     [PASS] 快于要求 51倍
```

---

## 附录

### 测试环境

- **操作系统**: Windows 10
- **Python版本**: 3.x
- **主要依赖**: 
  - Flask (Web服务)
  - pydicom (DICOM处理)
  - pandas (CSV处理)
  - Ascon (加密算法)
  - SPHINCS+ (后量子签名)

### 测试脚本

- **完整流程测试**: `test_full_pipeline.py`
- **结果文件**: `full_pipeline_performance.json`
- **Batch ID**: `test_1761207595727`

### 数据文件位置

- **加密后文件**: `output/test_1761207595727/`
  - `protected_dicom/`: 5000个加密的DICOM文件
  - `protected_text/`: 5000个加密的JSON文件
  
- **存储库**: `storage_repo/`
  - `cas/`: Content-Addressable Storage
  - `db/index.sqlite`: SQLite索引数据库

---

**报告生成时间**: 2025-10-23  
**测试执行人员**: 系统自动化测试  
**报告版本**: v1.0

