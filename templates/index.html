<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医疗隐私保护系统 - 跨模态检测</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/dicom-parser@1.8.3/dist/dicomParser.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>医疗隐私保护系统</h1>
            <p>基于注意力机制的跨模态隐私关联检测</p>
        </header>

        <div class="upload-section">
            <h2>数据上传</h2>
            
            <!-- 单文件上传模式 -->
            <div class="upload-mode">
                <h3>单文件处理</h3>
                <form id="singleUploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="csvFile">诊断报告CSV文件:</label>
                        <input type="file" id="csvFile" name="csv" accept=".csv" required />
                        <small>请上传包含诊断报告的CSV文件</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="dicom">DICOM文件:</label>
                        <input type="file" id="dicom" name="dicom" accept=".dcm" />
                        <small>可选：上传对应的DICOM文件</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">上传并检测</button>
                </form>
            </div>

            <!-- 批量处理模式 -->
            <div class="upload-mode">
                <h3>批量处理</h3>
                <form id="batchUploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="batchCsvFiles">CSV文件（可多选）:</label>
                        <input type="file" id="batchCsvFiles" name="csv_files" accept=".csv" multiple required />
                        <small>请选择一个或多个CSV文件</small>
        </div>
        
                    <div class="form-group">
                        <label for="batchDicomFiles">DICOM文件（可多选）:</label>
                        <input type="file" id="batchDicomFiles" name="dicom_files" accept=".dcm" multiple />
                        <small>请选择一个或多个DICOM文件（可选）</small>
        </div>
        
                    <button type="submit" class="btn btn-secondary">批量处理</button>
    </form>
            </div>
        </div>

        <!-- 处理进度 -->
        <div id="progress" class="progress-section" style="display:none;">
            <h3>处理进度</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">正在处理...</p>
        </div>

        <!-- 检测结果 -->
        <div id="results" class="results-section" style="display:none;">
        <h2>检测结果</h2>
            
            <div class="results-tabs">
                <button class="tab-btn active" onclick="showTab('textResults')">文本实体</button>
                <button class="tab-btn" onclick="showTab('imageResults')">影像区域</button>
                <button class="tab-btn" onclick="showTab('crossModalResults')">跨模态关联</button>
                <button class="tab-btn" onclick="showTab('riskAssessment')">风险评估</button>
            </div>

            <div id="textResults" class="tab-content active">
                <h3>检测到的敏感实体</h3>
                <div id="entitiesList"></div>
            </div>

            <div id="imageResults" class="tab-content">
                <h3>影像ROI区域</h3>
                <div id="roiDisplay"></div>
            </div>

            <div id="crossModalResults" class="tab-content">
                <h3>跨模态关联检测</h3>
                <div id="crossModalList"></div>
            </div>

            <div id="riskAssessment" class="tab-content">
                <h3>风险评估</h3>
                <div id="riskMetrics"></div>
            </div>

            <div class="action-buttons">
                <button id="protectBtn" class="btn btn-success">执行保护</button>
                <button id="downloadBtn" class="btn btn-info">下载结果</button>
            </div>
        </div>

        <!-- 保护结果 -->
        <div id="protectionResults" class="protection-section" style="display:none;">
            <h2>🔒 保护结果</h2>
            <div id="protectionStatus"></div>
            <div id="protectedData"></div>
            
            <div class="action-buttons" style="margin-top: 20px;">
                <button id="storageIngestBtn" class="btn btn-primary" style="display:none;">存储入库</button>
                <button id="viewStorageBtn" class="btn btn-info" onclick="showStorageManagement()">查看存储</button>
            </div>
        </div>

        <!-- 存储管理 -->
        <div id="storageManagement" class="results-section" style="display:none;">
            <h2>📦 存储管理</h2>
            
            <div class="results-tabs">
                <button class="tab-btn active" onclick="showStorageTab('storageObjects')">存储对象</button>
                <button class="tab-btn" onclick="showStorageTab('storageBatches')">批次列表</button>
                <button class="tab-btn" onclick="showStorageTab('storageStats')">统计信息</button>
                <button class="tab-btn" onclick="showStorageTab('verificationTab')">验证工具</button>
            </div>

            <div id="storageObjects" class="tab-content active">
                <h3>存储对象列表</h3>
                <button onclick="loadStorageObjects()" class="btn btn-secondary" style="margin-bottom:15px;">刷新列表</button>
                <div id="storageObjectsList"></div>
            </div>

            <div id="storageBatches" class="tab-content">
                <h3>批次列表</h3>
                <button onclick="loadStorageBatches()" class="btn btn-secondary" style="margin-bottom:15px;">刷新列表</button>
                <div id="storageBatchesList"></div>
            </div>

            <div id="storageStats" class="tab-content">
                <h3>存储统计</h3>
                <button onclick="loadStorageStats()" class="btn btn-secondary" style="margin-bottom:15px;">刷新统计</button>
                <div id="storageStatsDisplay"></div>
            </div>

            <div id="verificationTab" class="tab-content">
                <h3>验证工具</h3>
                <div class="form-group">
                    <label for="verifyPatientId">Patient ID:</label>
                    <input type="text" id="verifyPatientId" placeholder="输入Patient ID (如: patient00826)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px;">
                </div>
                <div class="action-buttons">
                    <button onclick="verifyRepo()" class="btn btn-primary">从仓库验证</button>
                    <button onclick="buildAndVerifyBundle()" class="btn btn-success">构建并验证Bundle</button>
                </div>
                <div id="verificationResults" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // 单文件上传处理
        document.getElementById('singleUploadForm').onsubmit = async function(e) {
            e.preventDefault();
            await handleSingleUpload();
        };

        // 批量处理
        document.getElementById('batchUploadForm').onsubmit = async function(e) {
            e.preventDefault();
            await handleBatchUpload();
        };

        // 保护按钮
        document.getElementById('protectBtn').onclick = async function() {
            await executeProtection();
        };

        // 下载按钮
        document.getElementById('downloadBtn').onclick = function() {
            downloadResults();
        };

        // 处理单文件上传
        async function handleSingleUpload() {
            const formData = new FormData(document.getElementById('singleUploadForm'));
            showProgress();
            
            try {
                // 先上传CSV文件
                const csvResponse = await fetch('/api/upload_csv', {
                method: 'POST',
                body: formData
            });
            
                const csvResult = await csvResponse.json();
                if (csvResult.status !== 'success') {
                    showError('CSV文件上传失败: ' + csvResult.error);
                    return;
                }
                
                // 如果有DICOM文件，也上传
                let dicomPath = null;
                const dicomFile = document.getElementById('dicom').files[0];
                if (dicomFile) {
                    const dicomFormData = new FormData();
                    dicomFormData.append('dicom', dicomFile);
                    
                    const dicomResponse = await fetch('/api/ingest', {
                        method: 'POST',
                        body: dicomFormData
                    });
                    
                    const dicomResult = await dicomResponse.json();
                    if (dicomResult.status === 'success') {
                        dicomPath = dicomResult.dicom_path;
                    }
                }
                
                // 执行检测
                const detectionResponse = await fetch('/api/detect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ingest_id: csvResult.csv_id,
                        csv_path: csvResult.csv_path,
                        dicom_path: dicomPath
                    })
                });
                
                const detectionResult = await detectionResponse.json();
                displayResults(detectionResult);
            } catch (error) {
                showError('处理失败: ' + error.message);
            } finally {
                hideProgress();
            }
        }

        // 处理批量上传（支持1个CSV对多个DICOM的场景）
        async function handleBatchUpload() {
            const csvFiles = document.getElementById('batchCsvFiles').files;
            const dicomFiles = document.getElementById('batchDicomFiles').files;
            
            if (csvFiles.length === 0) {
                alert('请至少选择一个CSV文件');
                return;
            }
            
            showProgress();
            updateProgress(0, `准备处理...`);
            
            try {
                // 场景判断：1个CSV + 多个DICOM（批量模式）vs 多个CSV + 多个DICOM（配对模式）
                if (csvFiles.length === 1 && dicomFiles.length > 1) {
                    // **批量模式**: 1个CSV包含多行，每行对应一个DICOM
                    await handleBatchMode(csvFiles[0], dicomFiles);
                } else {
                    // **配对模式**: 多个CSV，每个CSV对应一个DICOM
                    await handlePairMode(csvFiles, dicomFiles);
                }
                
            } catch (error) {
                alert('批量处理失败: ' + error.message);
                console.error(error);
            } finally {
                hideProgress();
            }
        }
        
        // 批量模式：1个CSV对多个DICOM（分批上传）
        async function handleBatchMode(csvFile, dicomFiles) {
            updateProgress(5, `读取CSV文件 ${csvFile.name}...`);
            
            // 1. 读取CSV文件，提取所有patient_id
            const csvText = await csvFile.text();
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            
            console.log(`CSV包含 ${lines.length - 1} 行数据`);
            console.log(`DICOM文件数: ${dicomFiles.length}`);
            
            // 提取所有patient信息
            const csvPatients = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const pathMatch = line.match(/patient(\d+)/i);
                if (pathMatch) {
                    csvPatients.push({
                        rowIndex: i - 1,
                        patientId: 'patient' + pathMatch[1],
                        patientNumber: pathMatch[1],
                        csvLine: line
                    });
                }
            }
            
            console.log(`从CSV提取到 ${csvPatients.length} 个patient_id`);
            
            // 2. 分批上传DICOM文件（每批100个）
            const BATCH_SIZE = 100;
            const allMetadata = [];
            const totalBatches = Math.ceil(dicomFiles.length / BATCH_SIZE);
            
            for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                const start = batchIndex * BATCH_SIZE;
                const end = Math.min(start + BATCH_SIZE, dicomFiles.length);
                const batchFiles = Array.from(dicomFiles).slice(start, end);
                
                const progressPercent = 10 + (batchIndex / totalBatches) * 60;
                updateProgress(progressPercent, `上传DICOM文件 ${start + 1}-${end}/${dicomFiles.length}...`);
                
                // 创建FormData
                const dicomFormData = new FormData();
                for (let dicomFile of batchFiles) {
                    dicomFormData.append('dicom_files', dicomFile);
                }
                
                // 上传这一批
                try {
                    const dicomUploadResponse = await fetch('/api/batch_upload_dicom', {
                        method: 'POST',
                        body: dicomFormData
                    });
                    
                    if (!dicomUploadResponse.ok) {
                        const errorText = await dicomUploadResponse.text();
                        console.error(`批次 ${batchIndex + 1} 上传失败:`, errorText);
                        throw new Error(`DICOM批次 ${batchIndex + 1} 上传失败: ${errorText}`);
                    }
                    
                    const dicomData = await dicomUploadResponse.json();
                    console.log(`批次 ${batchIndex + 1}/${totalBatches} 上传完成: ${dicomData.processed} 个文件`);
                    
                    // 合并元数据
                    if (dicomData.metadata_list) {
                        allMetadata.push(...dicomData.metadata_list);
                    }
                } catch (error) {
                    console.error(`批次 ${batchIndex + 1} 处理失败:`, error);
                    alert(`警告: 批次 ${batchIndex + 1} 处理失败，继续处理其他批次...`);
                }
            }
            
            console.log(`所有DICOM上传完成，共提取 ${allMetadata.length} 个元数据`);
            updateProgress(75, `上传CSV并开始跨模态匹配...`);
            
            // 3. 上传CSV
            const csvFormData = new FormData();
            csvFormData.append('csv_file', csvFile);
            const csvResponse = await fetch('/api/upload_csv', {method: 'POST', body: csvFormData});
            
            if (!csvResponse.ok) {
                throw new Error('CSV上传失败');
            }
            
            const csvUploadData = await csvResponse.json();
            
            // 4. 调用批量检测API
            updateProgress(80, `执行跨模态匹配...`);
            const batchDetectResponse = await fetch('/api/batch_detect', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    csv_path: csvUploadData.csv_path,
                    dicom_metadata_list: allMetadata
                })
            });
            
            if (!batchDetectResponse.ok) {
                const errorText = await batchDetectResponse.text();
                throw new Error(`批量检测失败: ${errorText}`);
            }
            
            const batchResult = await batchDetectResponse.json();
            
            updateProgress(100, '批量处理完成！');
            console.log('批量检测结果:', batchResult);
            console.log('Results数组长度:', batchResult.results ? batchResult.results.length : 'undefined');
            console.log('前5个结果:', batchResult.results ? batchResult.results.slice(0, 5) : 'undefined');
            
            // 显示结果
            displayBatchModeResults(batchResult);
        }
        
        // 配对模式：多个CSV对多个DICOM（原逻辑保留）
        async function handlePairMode(csvFiles, dicomFiles) {
            const results = [];
            for (let i = 0; i < csvFiles.length; i++) {
                const csvFile = csvFiles[i];
                updateProgress((i / csvFiles.length) * 100, `处理 ${csvFile.name}...`);
                
                // 简单的文件名匹配
                let matchedDicom = null;
                const csvBaseName = csvFile.name.replace(/\.csv$/i, '').toLowerCase();
                for (let dicomFile of dicomFiles) {
                    const dicomBaseName = dicomFile.name.replace(/\.dcm$/i, '').toLowerCase();
                    if (csvBaseName === dicomBaseName) {
                        matchedDicom = dicomFile;
                        break;
                    }
                }
                
                results.push({
                    csv_file: csvFile.name,
                    dicom_file: matchedDicom ? matchedDicom.name : 'None',
                    result: {text_entities: [], mappings: []}
                });
            }
            
            updateProgress(100, '完成！');
            displayBatchResults(results);
        }

                // 显示检测结果
        function displayResults(result) {
            console.log('检测结果:', result); // 添加调试信息
            document.getElementById('results').style.display = 'block';
            
            // 显示文本实体
            const entitiesList = document.getElementById('entitiesList');
            entitiesList.innerHTML = '';
            
            const entities = result.entities || result.text_entities || [];
            if (entities.length > 0) {
                console.log('检测到实体数量:', entities.length); // 添加调试信息
                
                // 按类型分组
                const entityGroups = {};
                entities.forEach(entity => {
                    if (!entityGroups[entity.type]) {
                        entityGroups[entity.type] = [];
                    }
                    entityGroups[entity.type].push(entity);
                });
                
                // 为每个类型创建分组显示
                Object.keys(entityGroups).sort().forEach(type => {
                    const groupDiv = document.createElement('div');
                    groupDiv.style.marginBottom = '20px';
                    
                    const groupHeader = document.createElement('h4');
                    groupHeader.style.color = '#495057';
                    groupHeader.style.marginBottom = '10px';
                    groupHeader.style.fontSize = '16px';
                    groupHeader.style.fontWeight = '600';
                    
                    // 根据类型设置图标
                    let icon = '📋';
                    if (type === 'NAME') icon = '👤';
                    else if (type === 'AGE') icon = '📅';
                    else if (type === 'SEX') icon = '⚧';
                    else if (type === 'PHONE') icon = '📱';
                    else if (type === 'ID') icon = '🆔';
                    else if (type === 'ADDRESS') icon = '📍';
                    else if (type === 'PATH') icon = '📁';
                    
                    groupHeader.innerHTML = `${icon} ${type} <span style="color: #6c757d; font-weight: 400;">(${entityGroups[type].length})</span>`;
                    groupDiv.appendChild(groupHeader);
                    
                    entityGroups[type].forEach(entity => {
                        const entityDiv = document.createElement('div');
                        entityDiv.className = 'entity-item';
                        entityDiv.innerHTML = `
                            <span class="entity-type">${entity.type}</span>
                            <span class="entity-text">${entity.text}</span>
                            <span class="entity-confidence">置信度: ${(entity.confidence * 100).toFixed(1)}%</span>
                        `;
                        groupDiv.appendChild(entityDiv);
                    });
                    
                    entitiesList.appendChild(groupDiv);
                });
            } else {
                console.log('未检测到实体，结果:', result); // 添加调试信息
                entitiesList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 30px;">未检测到敏感实体</p>';
            }
            
            // 显示跨模态关联
            const crossModalList = document.getElementById('crossModalList');
            crossModalList.innerHTML = '';
            
            if (result.mappings && result.mappings.length > 0) {
                result.mappings.forEach((mapping, index) => {
                    const mappingDiv = document.createElement('div');
                    mappingDiv.className = `risk-item ${mapping.risk_level}`;
                    
                    // 根据匹配类型设置图标和标题
                    let icon = '🔗';
                    let title = '跨模态关联';
                    if (mapping.match_type === 'patient_id_exact_match') {
                        icon = '✅';
                        title = 'Patient ID 完全匹配';
                    } else if (mapping.match_type === 'patient_id_mismatch') {
                        icon = '❌';
                        title = 'Patient ID 不匹配';
                    } else if (mapping.match_type === 'name_match') {
                        icon = '👤';
                        title = '姓名匹配';
                    } else if (mapping.match_type === 'age_match') {
                        icon = '📅';
                        title = '年龄匹配';
                    } else if (mapping.match_type === 'sex_match') {
                        icon = '⚧';
                        title = '性别匹配';
                    }
                    
                    mappingDiv.innerHTML = `
                        <div>${icon} ${title}</div>
                        <div><strong>CSV位置:</strong> 第 <code>${mapping.csv_row}</code> 行，<code>${mapping.csv_column}</code> 列</div>
                        <div><strong>CSV值:</strong> <code>${mapping.csv_value}</code></div>
                        ${mapping.extracted_patient_id ? `<div><strong>提取的Patient ID:</strong> <code>${mapping.extracted_patient_id}</code></div>` : ''}
                        <div><strong>DICOM字段:</strong> <code>${mapping.dicom_field}</code> = <code>${mapping.dicom_value}</code></div>
                        <div>
                            <strong>置信度:</strong> <span style="color: ${mapping.confidence >= 0.9 ? '#28a745' : mapping.confidence >= 0.7 ? '#ffc107' : '#dc3545'}; font-weight: 700;">${(mapping.confidence * 100).toFixed(1)}%</span>
                            <span style="margin: 0 10px;">|</span>
                            <strong>风险级别:</strong> <span class="risk-level ${mapping.risk_level}">${mapping.risk_level}</span>
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef;">
                            <strong>说明:</strong> ${mapping.description}
                        </div>
                    `;
                    crossModalList.appendChild(mappingDiv);
                });
            } else {
                crossModalList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 30px;">未发现跨模态关联</p>';
            }
            
            // 显示跨模态风险
            if (result.cross_modal_risks && result.cross_modal_risks.length > 0) {
                result.cross_modal_risks.forEach(risk => {
                    const riskDiv = document.createElement('div');
                    riskDiv.className = 'risk-item';
                    riskDiv.innerHTML = `
                        <span class="risk-level ${risk.risk_level}">${risk.risk_level}</span>
                        <span class="risk-description">${risk.description}</span>
                    `;
                    crossModalList.appendChild(riskDiv);
                });
            }
            
            // 显示风险指标
            if (result.metrics) {
                const riskMetrics = document.getElementById('riskMetrics');
                riskMetrics.innerHTML = `
                    <div class="metric-item">
                        <span>F1分数: ${(result.metrics.f1_score * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric-item">
                        <span>处理时间: ${result.metrics.processing_time.toFixed(2)}秒</span>
                    </div>
                    <div class="metric-item">
                        <span>高风险实体: ${result.metrics.high_risk_entities_count}</span>
                    </div>
                `;
            }
        }

        // 显示批量模式结果（1个CSV对多个DICOM）
        function displayBatchModeResults(data) {
            console.log('displayBatchModeResults called with:', data);
            document.getElementById('results').style.display = 'block';
            
            // 保存检测结果到全局变量，供保护功能使用
            currentDetectionResult = data;
            currentBatchId = `batch_${Date.now()}`;
            
            // 1. 处理文本实体 - 汇总所有CSV数据中的敏感信息
            displayBatchTextEntities(data);
            
            // 2. 处理跨模态关联 - 显示匹配详情
            displayBatchCrossmodalMatches(data);
            
            // 3. 影像区域提示
            const roiDisplay = document.getElementById('roiDisplay');
            if (roiDisplay) {
                roiDisplay.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        <p>批量处理模式下，DICOM影像ROI信息已包含在元数据中。</p>
                        <p>共处理 ${data.matched} 个DICOM文件的元数据。</p>
                    </div>
                `;
            }
            
            // 4. 显示风险指标
            const riskMetrics = document.getElementById('riskMetrics');
            if (riskMetrics) {
                riskMetrics.innerHTML = `
                    <div class="metric-item">
                        <span>总病人数: ${data.total_patients}</span>
                    </div>
                    <div class="metric-item">
                        <span>成功匹配: ${data.matched} / ${data.total_patients} (${data.match_rate.toFixed(1)}%)</span>
                    </div>
                    <div class="metric-item">
                        <span>未匹配: ${data.unmatched}</span>
                    </div>
                `;
            }
            
            // 默认切换到文本实体标签页
            showTab('textResults');
        }
        
        // 显示批量文本实体（汇总）
        function displayBatchTextEntities(data) {
            const entitiesList = document.getElementById('entitiesList');
            
            if (!entitiesList) {
                console.error('[ERROR] entitiesList元素未找到');
                return;
            }
            
            if (!data || !data.results || data.results.length === 0) {
                entitiesList.innerHTML = '<p style="color: red;">错误：未收到有效数据</p>';
                return;
            }
            
            // 汇总所有敏感实体
            const entityGroups = {
                'NAME': { icon: '👤', entities: [] },
                'SEX': { icon: '⚧', entities: [] },
                'AGE': { icon: '📅', entities: [] },
                'PHONE': { icon: '📱', entities: [] },
                'ID_NUMBER': { icon: '🆔', entities: [] },
                'ADDRESS': { icon: '📍', entities: [] },
                'PATH': { icon: '📁', entities: [] }
            };
            
            // 从所有匹配结果中提取实体（性能优化：最多处理前1000条）
            const processingLimit = Math.min(1000, data.results.length);
            for (let i = 0; i < processingLimit; i++) {
                const match = data.results[i];
                if (match.csv_data) {
                    const csvData = match.csv_data;
                    
                    // 提取各类实体
                    if (csvData.Name) entityGroups['NAME'].entities.push({ value: csvData.Name, row: match.row_index });
                    if (csvData.Sex) entityGroups['SEX'].entities.push({ value: csvData.Sex, row: match.row_index });
                    if (csvData.Age) entityGroups['AGE'].entities.push({ value: csvData.Age, row: match.row_index });
                    if (csvData.Phone) entityGroups['PHONE'].entities.push({ value: csvData.Phone, row: match.row_index });
                    if (csvData.ID_Number) entityGroups['ID_NUMBER'].entities.push({ value: csvData.ID_Number, row: match.row_index });
                    if (csvData.Address) entityGroups['ADDRESS'].entities.push({ value: csvData.Address, row: match.row_index });
                    if (csvData.Path) entityGroups['PATH'].entities.push({ value: csvData.Path, row: match.row_index });
                }
            }
            
            if (data.results.length > 1000) {
                console.log(`[PERF] 仅处理前1000条数据用于显示，总共${data.results.length}条`);
            }
            
            let html = '<h4>检测到的敏感实体（批量汇总）</h4>';
            html += `<p style="color: #666; margin-bottom: 20px;">共处理 ${data.total_patients} 条记录，匹配 ${data.matched} 个DICOM文件</p>`;
            
            // 显示每类实体（仅显示前20条）
            for (const [entityType, group] of Object.entries(entityGroups)) {
                if (group.entities.length > 0) {
                    // 去重
                    const uniqueEntities = [...new Set(group.entities.map(e => String(e.value)))];
                    const displayCount = Math.min(20, group.entities.length);
                    
                    html += `
                        <div class="entity-group" style="margin-bottom: 20px;">
                            <h5 style="color: #333; margin-bottom: 10px;">
                                ${group.icon} ${entityType} (${group.entities.length} 条，去重后 ${uniqueEntities.length} 个唯一值)
                            </h5>
                    `;
                    
                    // 显示前20条
                    for (let i = 0; i < displayCount; i++) {
                        const entity = group.entities[i];
                        html += `
                            <div class="entity-item" style="margin: 8px 0;">
                                <span class="entity-type">${entityType}</span>
                                <span class="entity-text">${entity.value}</span>
                                <span class="entity-confidence">行${entity.row + 1} | 98.0%</span>
                            </div>
                        `;
                    }
                    
                    if (group.entities.length > 20) {
                        html += `<p style="color: #999; text-align: center; margin: 10px 0;">... 还有 ${group.entities.length - 20} 条未显示 ...</p>`;
                    }
                    
                    html += '</div>';
                }
            }
            
            entitiesList.innerHTML = html;
        }
        
        // 显示批量跨模态匹配
        function displayBatchCrossmodalMatches(data) {
            const crossmodalList = document.getElementById('crossModalList');  // 注意大小写
            
            if (!crossmodalList) {
                console.error('[ERROR] crossModalList元素未找到');
                return;
            }
            
            if (!data || !data.total_patients) {
                crossmodalList.innerHTML = '<p style="color: red;">错误：未收到有效数据</p>';
                return;
            }
            
            const matchRate = data.total_patients > 0 ? (data.matched / data.total_patients * 100).toFixed(1) : 0;
            const hasResults = data.results && data.results.length > 0;
            
            let html = `
                <h4>跨模态关联检测（批量）</h4>
                <div class="batch-summary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h4 style="color: white;">🏥 批量跨模态检测完成</h4>
                    <p><strong>CSV文件:</strong> ${data.csv_file || 'unknown'}</p>
                    <p><strong>总病人数:</strong> ${data.total_patients} 人</p>
                    <p><strong>已处理:</strong> ${data.processed} 人</p>
                    <p><strong>成功匹配DICOM:</strong> ${data.matched} / ${data.total_patients} (${matchRate}%)</p>
                    <p><strong>未匹配:</strong> ${data.unmatched} 人</p>
                </div>
            `;
            
            if (hasResults) {
                html += `<div style="margin: 20px 0;"><h4>匹配详情（前20条）:</h4></div>`;
                
                // 显示前20条匹配结果，像单文件一样详细
                const displayCount = Math.min(20, data.results.length);
                for (let i = 0; i < displayCount; i++) {
                    const item = data.results[i];
                    if (!item.matched) continue; // 只显示成功匹配的
                    
                    const csvData = item.csv_data || {};
                    const dicomMeta = item.dicom_metadata || {};
                    
                    html += `
                        <div class="crossmodal-card" style="margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                            <h5 style="color: #333; margin-bottom: 10px;">📋 Patient ${item.patient_id} (CSV第${item.row_index + 1}行)</h5>
                            
                            <div class="mapping-item" style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                                <strong style="color: #28a745;">✅ Patient ID 完全匹配</strong>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>CSV位置:</strong> 第 ${item.row_index} 行，Path 列<br>
                                    <strong>CSV值:</strong> ${csvData.Path || 'N/A'}<br>
                                    <strong>提取的Patient ID:</strong> ${item.patient_id}<br>
                                    <strong>DICOM字段:</strong> patient_id = ${dicomMeta.patient_id || 'N/A'}<br>
                                    <strong>置信度:</strong> ${(item.confidence * 100).toFixed(1)}% | 
                                    <strong>风险级别:</strong> <span style="color: #dc3545;">${item.risk_level || 'critical'}</span>
                                </p>
                                <p style="color: #999; font-size: 0.9em; margin: 5px 0;">
                                    说明: CSV Path中的patient_id (${item.patient_id}) 与 DICOM patient_id 完全匹配
                                </p>
                            </div>
                            
                            ${csvData.Sex && dicomMeta.patient_sex ? `
                            <div class="mapping-item" style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                                <strong style="color: #ffc107;">⚧ 性别匹配</strong>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>CSV位置:</strong> 第 ${item.row_index} 行，Sex 列<br>
                                    <strong>CSV值:</strong> ${csvData.Sex}<br>
                                    <strong>DICOM字段:</strong> patient_sex = ${dicomMeta.patient_sex}<br>
                                    <strong>置信度:</strong> 90.0% | <strong>风险级别:</strong> medium
                                </p>
                                <p style="color: #999; font-size: 0.9em; margin: 5px 0;">
                                    说明: 性别匹配: ${csvData.Sex}
                                </p>
                            </div>
                            ` : ''}
                            
                            ${csvData.Age && dicomMeta.patient_age ? `
                            <div class="mapping-item" style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                                <strong style="color: #17a2b8;">📅 年龄匹配</strong>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>CSV值:</strong> ${csvData.Age} 岁<br>
                                    <strong>DICOM值:</strong> ${dicomMeta.patient_age}<br>
                                    <strong>置信度:</strong> 85.0% | <strong>风险级别:</strong> medium
                                </p>
                            </div>
                            ` : ''}
                            
                            <div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 4px;">
                                <strong style="color: #856404;">⚠️ 检测到高风险实体:</strong>
                                ${csvData.Name ? `<span style="margin: 0 5px; color: #dc3545;">NAME</span>` : ''}
                                ${csvData.Phone ? `<span style="margin: 0 5px; color: #dc3545;">PHONE</span>` : ''}
                                ${csvData.ID_Number ? `<span style="margin: 0 5px; color: #dc3545;">ID_NUMBER</span>` : ''}
                                ${csvData.Address ? `<span style="margin: 0 5px; color: #dc3545;">ADDRESS</span>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                if (data.results.length > 20) {
                    html += `<p style="text-align: center; color: #666; margin: 20px 0;">... 还有 ${data.results.length - 20} 条结果未显示 ...</p>`;
                }
            } else {
                html += '<p style="color: #dc3545;">警告：未找到匹配结果数据</p>';
            }
            
            // 添加说明
            html += `
                <div style="margin-top: 20px; padding: 15px; background: ${data.matched > 0 ? '#d4edda' : '#f8d7da'}; border-left: 4px solid ${data.matched > 0 ? '#28a745' : '#dc3545'}; border-radius: 4px;">
                    <h4 style="color: ${data.matched > 0 ? '#155724' : '#721c24'}; margin-bottom: 10px;">
                        ${data.matched > 0 ? '✅ 匹配成功' : '⚠️ 匹配失败'}
                    </h4>
                    ${data.matched > 0 ? `
                        <p style="color: #155724;">
                            系统从CSV的Path列中提取了 ${data.total_patients} 个patient_id<br>
                            从DICOM文件中提取了 ${data.matched > 0 ? '有效的' : ''} patient_id<br>
                            成功匹配了 ${data.matched} 个跨模态关联！<br>
                            跨模态关联检测已完成。
                        </p>
                    ` : `
                        <p style="color: #721c24;">
                            <strong>可能原因：</strong><br>
                            1. DICOM元数据中的patient_id与CSV中的patient_id不匹配<br>
                            2. DICOM文件可能缺少patient_id字段<br>
                        </p>
                    `}
                </div>
            `;
            
            crossmodalList.innerHTML = html;
            console.log('Results displayed successfully in crossmodal tab');
        }
        
        // 显示批量处理结果（配对模式）
        function displayBatchResults(results) {
                document.getElementById('results').style.display = 'block';
            
            const entitiesList = document.getElementById('entitiesList');
            
            // 统计信息
            let totalEntities = 0;
            let totalMappings = 0;
            let filesWithDicom = 0;
            
            results.forEach(item => {
                totalEntities += (item.result.text_entities || []).length;
                totalMappings += (item.result.mappings || []).length;
                if (item.dicom_file !== 'None') filesWithDicom++;
            });
            
            let summaryHTML = `
                <div class="batch-summary">
                    <h4>📊 批量处理完成</h4>
                    <p><strong>文件总数:</strong> ${results.length} 对</p>
                    <p><strong>匹配DICOM:</strong> ${filesWithDicom} / ${results.length}</p>
                    <p><strong>检测实体:</strong> ${totalEntities} 个</p>
                    <p><strong>跨模态关联:</strong> ${totalMappings} 个</p>
                    ${filesWithDicom === 0 ? '<p style="color: #dc3545;">⚠️ 未找到匹配的DICOM文件，无法进行跨模态检测</p>' : ''}
                </div>
            `;
            
            // 显示每个文件的结果摘要
            results.forEach((item, index) => {
                const entityCount = (item.result.text_entities || []).length;
                const mappingCount = (item.result.mappings || []).length;
                const hasDicom = item.dicom_file !== 'None';
                
                // 根据是否有DICOM设置边框颜色
                const borderColor = hasDicom ? (mappingCount > 0 ? '#28a745' : '#ffc107') : '#dc3545';
                
                summaryHTML += `
                    <div class="entity-item" style="margin: 10px 0; border-left-color: ${borderColor};">
                        <span class="entity-type" style="background: ${borderColor};">#${index + 1}</span>
                        <span class="entity-text">
                            📄 <strong>CSV:</strong> ${item.csv_file}<br>
                            🏥 <strong>DICOM:</strong> ${item.dicom_file} ${!hasDicom ? '❌' : '✅'}<br>
                            📝 <strong>检测实体:</strong> ${entityCount} 个<br>
                            🔗 <strong>跨模态关联:</strong> ${mappingCount} 个 ${!hasDicom ? '(需要DICOM文件)' : ''}
                        </span>
                        <span class="entity-confidence">
                            ${item.result.metrics && item.result.metrics.f1_score 
                                ? 'F1: ' + (item.result.metrics.f1_score * 100).toFixed(1) + '%' 
                                : (hasDicom ? 'N/A' : '无DICOM')}
                        </span>
                    </div>
                `;
            });
            
            // 添加说明
            summaryHTML += `
                <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
                    <h4 style="color: #1976D2; margin-bottom: 10px;">💡 文件匹配说明</h4>
                    <p style="margin: 5px 0; color: #555;">系统会自动根据文件名匹配CSV和DICOM：</p>
                    <ul style="margin: 10px 0; padding-left: 20px; color: #555;">
                        <li><code>patient001.csv</code> ↔ <code>patient001.dcm</code></li>
                        <li><code>study_001.csv</code> ↔ <code>study_001.dcm</code></li>
                        <li>或CSV中的Path列包含的patient_id与DICOM文件名匹配</li>
                    </ul>
                    <p style="margin: 5px 0; color: #555;">
                        ${filesWithDicom === 0 
                            ? '⚠️ <strong>建议:</strong> 请确保CSV和DICOM文件名有相同的标识符' 
                            : '✅ 已成功匹配 ' + filesWithDicom + ' 对文件'}
                    </p>
                </div>
            `;
            
            entitiesList.innerHTML = summaryHTML;
        }
        
        // 更新进度条
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // 全局变量：保存当前检测结果和批次ID
        let currentDetectionResult = null;
        let currentBatchId = null;

        // 执行保护
        async function executeProtection() {
            const protectBtn = document.getElementById('protectBtn');
            protectBtn.disabled = true;
            protectBtn.textContent = '正在保护...';
            
            try {
                if (!currentDetectionResult) {
                    showError('请先执行批量检测');
                    return;
                }
                
                updateProgress(10, '开始执行保护...');
                showProgress();
                
                // 调用保护API
                const response = await fetch('/api/protect_execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        detection_result: currentDetectionResult,
                        batch_id: currentBatchId
                    })
                });
                
                updateProgress(60, '保护中...');
                
                const result = await response.json();
                
                if (result.batch_id) {
                    currentBatchId = result.batch_id;
                    updateProgress(100, '保护完成！');
                    
                    document.getElementById('protectionResults').style.display = 'block';
                    document.getElementById('protectionStatus').innerHTML = `
                        <div class="protection-success">
                            <h3>✅ 保护完成</h3>
                            <p><strong>批次ID:</strong> ${result.batch_id}</p>
                            <p><strong>保护数量:</strong> ${result.protected_count} 个对象</p>
                            <p><strong>密钥提示:</strong> ${result.key_hint}</p>
                            <p><strong>输出DICOM:</strong> ${result.output_dicom}</p>
                            <p><strong>输出文本:</strong> ${result.output_text}</p>
                            <p><strong>审计清单:</strong> ${result.audit_manifest}</p>
                        </div>
                    `;
                    
                    // 显示入库按钮
                    document.getElementById('storageIngestBtn').style.display = 'inline-flex';
                    document.getElementById('storageIngestBtn').onclick = function() {
                        storageIngest(currentBatchId);
                    };
                    
                    document.getElementById('protectionResults').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showError('保护失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                showError('保护过程出错: ' + error.message);
            } finally {
                hideProgress();
                protectBtn.disabled = false;
                protectBtn.textContent = '执行保护';
            }
        }

        // 存储入库
        async function storageIngest(batchId) {
            try {
                updateProgress(10, '开始存储入库...');
                showProgress();
                
                const response = await fetch('/api/storage/ingest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        batch_id: batchId
                    })
                });
                
                updateProgress(60, '入库中...');
                
                const result = await response.json();
                
                if (result.batch_id) {
                    updateProgress(100, '入库完成！');
                    alert(`入库成功！\n批次ID: ${result.batch_id}\n入库数量: ${result.ingested}\n审计SHA256: ${result.audit_sha256}`);
                } else {
                    showError('入库失败: ' + (result.error || '未知错误'));
                }
            } catch (error) {
                showError('入库过程出错: ' + error.message);
            } finally {
                hideProgress();
            }
        }

        // 显示存储管理
        function showStorageManagement() {
            document.getElementById('storageManagement').style.display = 'block';
            document.getElementById('storageManagement').scrollIntoView({ behavior: 'smooth' });
            loadStorageObjects();
        }

        // 存储标签页切换
        function showStorageTab(tabName) {
            const tabContents = document.querySelectorAll('#storageManagement .tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            const tabBtns = document.querySelectorAll('#storageManagement .tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));
            
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            if (window.event && window.event.target) {
                window.event.target.classList.add('active');
            }
        }

        // 加载存储对象
        async function loadStorageObjects() {
            try {
                const response = await fetch('/api/storage/list?limit=20&offset=0');
                const result = await response.json();
                
                const list = document.getElementById('storageObjectsList');
                if (result.objects && result.objects.length > 0) {
                    let html = '<div class="entity-group">';
                    result.objects.forEach(obj => {
                        html += `
                            <div class="entity-item">
                                <span class="entity-type">ID#${obj.id}</span>
                                <span class="entity-text">
                                    <strong>Patient:</strong> ${obj.patient_id}<br>
                                    <strong>SOP:</strong> ${obj.sop_uid || 'N/A'}<br>
                                    <strong>Batch:</strong> ${obj.batch_id}<br>
                                    <strong>DICOM SHA256:</strong> ${obj.dicom_sha256.substring(0, 16)}...
                                </span>
                                <span class="entity-confidence">${new Date(obj.timestamp).toLocaleString()}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    list.innerHTML = html;
                } else {
                    list.innerHTML = '<p style="text-align:center; color:#666;">暂无存储对象</p>';
                }
            } catch (error) {
                document.getElementById('storageObjectsList').innerHTML = `<p style="color:red;">加载失败: ${error.message}</p>`;
            }
        }

        // 加载批次列表
        async function loadStorageBatches() {
            try {
                const response = await fetch('/api/storage/batches?limit=20');
                const result = await response.json();
                
                const list = document.getElementById('storageBatchesList');
                if (result.batches && result.batches.length > 0) {
                    let html = '<div class="entity-group">';
                    result.batches.forEach(batch => {
                        html += `
                            <div class="entity-item">
                                <span class="entity-type">BATCH</span>
                                <span class="entity-text">
                                    <strong>ID:</strong> ${batch.batch_id}<br>
                                    <strong>对象数:</strong> ${batch.count || 'N/A'}<br>
                                    <strong>审计SHA256:</strong> ${batch.audit_sha256 ? batch.audit_sha256.substring(0, 16) + '...' : 'N/A'}<br>
                                    <strong>签名:</strong> ${batch.has_signature ? '✅ 已签名' : '❌ 未签名'}
                                </span>
                                <span class="entity-confidence">${new Date(batch.timestamp).toLocaleString()}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    list.innerHTML = html;
                } else {
                    list.innerHTML = '<p style="text-align:center; color:#666;">暂无批次</p>';
                }
            } catch (error) {
                document.getElementById('storageBatchesList').innerHTML = `<p style="color:red;">加载失败: ${error.message}</p>`;
            }
        }

        // 加载存储统计
        async function loadStorageStats() {
            try {
                const response = await fetch('/api/storage/stats');
                const result = await response.json();
                
                const display = document.getElementById('storageStatsDisplay');
                display.innerHTML = `
                    <div class="batch-summary">
                        <h4>📊 存储统计</h4>
                        <p><strong>总对象数:</strong> ${result.total_objects}</p>
                        <p><strong>总批次数:</strong> ${result.total_batches}</p>
                        <p><strong>仓库路径:</strong> ${result.repo_path}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('storageStatsDisplay').innerHTML = `<p style="color:red;">加载失败: ${error.message}</p>`;
            }
        }

        // 从仓库验证
        async function verifyRepo() {
            const patientId = document.getElementById('verifyPatientId').value.trim();
            if (!patientId) {
                alert('请输入Patient ID');
                return;
            }
            
            try {
                const response = await fetch('/api/verify/repo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_id: patientId
                    })
                });
                
                const result = await response.json();
                displayVerificationResults(result, '仓库验证');
            } catch (error) {
                alert('验证失败: ' + error.message);
            }
        }

        // 构建并验证Bundle
        async function buildAndVerifyBundle() {
            const patientId = document.getElementById('verifyPatientId').value.trim();
            if (!patientId) {
                alert('请输入Patient ID');
                return;
            }
            
            try {
                // 先构建bundle
                const buildResp = await fetch('/api/storage/bundle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_id: patientId
                    })
                });
                
                const buildResult = await buildResp.json();
                
                if (buildResult.status !== 'success') {
                    alert('构建Bundle失败: ' + (buildResult.error || '未知错误'));
                    return;
                }
                
                // 再验证bundle
                const verifyResp = await fetch('/api/verify/bundle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_id: patientId
                    })
                });
                
                const verifyResult = await verifyResp.json();
                displayVerificationResults(verifyResult, 'Bundle验证', buildResult.bundle_path);
                
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        // 显示验证结果
        function displayVerificationResults(result, title, bundlePath) {
            const display = document.getElementById('verificationResults');
            
            let html = `<h4>${title}结果</h4>`;
            
            if (result.error) {
                html += `<div class="risk-item high"><p style="color:red;">错误: ${result.error}</p></div>`;
            } else {
                // 签名验证
                if (result.sig_ok !== null) {
                    html += `
                        <div class="risk-item ${result.sig_ok ? 'low' : 'high'}">
                            <h5>${result.sig_ok ? '✅' : '❌'} SPHINCS+签名验证</h5>
                            <p><strong>状态:</strong> ${result.sig_ok ? '通过' : '失败'}</p>
                        </div>
                    `;
                }
                
                // 对验证结果
                if (result.pair) {
                    const issues = result.pair.issues || [];
                    html += `
                        <div class="risk-item ${issues.length === 0 ? 'low' : 'medium'}">
                            <h5>📋 DICOM-JSON对验证</h5>
                            <p><strong>DICOM:</strong> ${result.pair.dicom}</p>
                            <p><strong>JSON:</strong> ${result.pair.text}</p>
                            <p><strong>问题数:</strong> ${issues.length}</p>
                            ${issues.length > 0 ? `<p><strong>问题:</strong> ${issues.join('; ')}</p>` : '<p style="color:green;">✅ 无问题</p>'}
                        </div>
                    `;
                    
                    // Header信息
                    if (result.pair.headers) {
                        html += `<div class="risk-item low"><h5>📝 DICOM Header</h5>`;
                        for (const [key, val] of Object.entries(result.pair.headers)) {
                            html += `<p><strong>${key}:</strong> ${val}</p>`;
                        }
                        html += `</div>`;
                    }
                }
                
                // Bundle路径
                if (bundlePath) {
                    html += `
                        <div class="risk-item low">
                            <h5>📦 Bundle位置</h5>
                            <p><strong>路径:</strong> ${bundlePath}</p>
                            <a href="/api/storage/bundle/${document.getElementById('verifyPatientId').value}/download" 
                               class="btn btn-success" style="margin-top:10px;">下载Bundle</a>
                        </div>
                    `;
                }
            }
            
            display.innerHTML = html;
        }

        // 显示进度
        function showProgress() {
            document.getElementById('progress').style.display = 'block';
            updateProgress(0, '开始处理...');
        }

        // 隐藏进度
        function hideProgress() {
            document.getElementById('progress').style.display = 'none';
        }

        // 更新进度
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // 显示错误
        function showError(message) {
            alert('错误: ' + message);
        }

        // 标签页切换
        function showTab(tabName) {
            // 隐藏所有标签内容
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // 移除所有标签按钮的激活状态
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));
            
            // 显示选中的标签内容
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // 激活对应的标签按钮（如果是从按钮点击触发的）
            if (window.event && window.event.target) {
                window.event.target.classList.add('active');
            } else {
                // 程序化调用时，根据tabName找到对应按钮
                const tabNameMap = {
                    'textResults': '文本实体',
                    'imageResults': '影像区域',
                    'crossModalResults': '跨模态关联',
                    'riskAssessment': '风险评估'
                };
                const btnText = tabNameMap[tabName];
                if (btnText) {
                    tabBtns.forEach(btn => {
                        if (btn.textContent === btnText) {
                            btn.classList.add('active');
                        }
                    });
                }
            }
        }

        // 下载结果
        function downloadResults() {
            // 实际应用中应该生成并下载结果文件
            alert('下载功能待实现');
        }
    </script>
</body>
</html>