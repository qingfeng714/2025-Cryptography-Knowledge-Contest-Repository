<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»ç–—éšç§ä¿æŠ¤ç³»ç»Ÿ - è·¨æ¨¡æ€æ£€æµ‹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/dicom-parser@1.8.3/dist/dicomParser.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>åŒ»ç–—éšç§ä¿æŠ¤ç³»ç»Ÿ</h1>
            <p>åŸºäºæ³¨æ„åŠ›æœºåˆ¶çš„è·¨æ¨¡æ€éšç§å…³è”æ£€æµ‹</p>
        </header>

        <div class="upload-section">
            <h2>æ•°æ®ä¸Šä¼ </h2>
            
            <!-- å•æ–‡ä»¶ä¸Šä¼ æ¨¡å¼ -->
            <div class="upload-mode">
                <h3>å•æ–‡ä»¶å¤„ç†</h3>
                <form id="singleUploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="csvFile">è¯Šæ–­æŠ¥å‘ŠCSVæ–‡ä»¶:</label>
                        <input type="file" id="csvFile" name="csv" accept=".csv" required />
                        <small>è¯·ä¸Šä¼ åŒ…å«è¯Šæ–­æŠ¥å‘Šçš„CSVæ–‡ä»¶</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="dicom">DICOMæ–‡ä»¶:</label>
                        <input type="file" id="dicom" name="dicom" accept=".dcm" />
                        <small>å¯é€‰ï¼šä¸Šä¼ å¯¹åº”çš„DICOMæ–‡ä»¶</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">ä¸Šä¼ å¹¶æ£€æµ‹</button>
                </form>
            </div>

            <!-- æ‰¹é‡å¤„ç†æ¨¡å¼ -->
            <div class="upload-mode">
                <h3>æ‰¹é‡å¤„ç†</h3>
                <form id="batchUploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="batchCsvFiles">CSVæ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰:</label>
                        <input type="file" id="batchCsvFiles" name="csv_files" accept=".csv" multiple required />
                        <small>è¯·é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªCSVæ–‡ä»¶</small>
        </div>
        
                    <div class="form-group">
                        <label for="batchDicomFiles">DICOMæ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰:</label>
                        <input type="file" id="batchDicomFiles" name="dicom_files" accept=".dcm" multiple />
                        <small>è¯·é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªDICOMæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</small>
        </div>
        
                    <button type="submit" class="btn btn-secondary">æ‰¹é‡å¤„ç†</button>
    </form>
            </div>
        </div>

        <!-- å¤„ç†è¿›åº¦ -->
        <div id="progress" class="progress-section" style="display:none;">
            <h3>å¤„ç†è¿›åº¦</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">æ­£åœ¨å¤„ç†...</p>
        </div>

        <!-- æ£€æµ‹ç»“æœ -->
        <div id="results" class="results-section" style="display:none;">
        <h2>æ£€æµ‹ç»“æœ</h2>
            
            <div class="results-tabs">
                <button class="tab-btn active" onclick="showTab('textResults')">æ–‡æœ¬å®ä½“</button>
                <button class="tab-btn" onclick="showTab('imageResults')">å½±åƒåŒºåŸŸ</button>
                <button class="tab-btn" onclick="showTab('crossModalResults')">è·¨æ¨¡æ€å…³è”</button>
                <button class="tab-btn" onclick="showTab('riskAssessment')">é£é™©è¯„ä¼°</button>
            </div>

            <div id="textResults" class="tab-content active">
                <h3>æ£€æµ‹åˆ°çš„æ•æ„Ÿå®ä½“</h3>
                <div id="entitiesList"></div>
            </div>

            <div id="imageResults" class="tab-content">
                <h3>å½±åƒROIåŒºåŸŸ</h3>
                <div id="roiDisplay"></div>
            </div>

            <div id="crossModalResults" class="tab-content">
                <h3>è·¨æ¨¡æ€å…³è”æ£€æµ‹</h3>
                <div id="crossModalList"></div>
            </div>

            <div id="riskAssessment" class="tab-content">
                <h3>é£é™©è¯„ä¼°</h3>
                <div id="riskMetrics"></div>
            </div>

            <div class="action-buttons">
                <button id="protectBtn" class="btn btn-success">æ‰§è¡Œä¿æŠ¤</button>
                <button id="downloadBtn" class="btn btn-info">ä¸‹è½½ç»“æœ</button>
            </div>
        </div>

        <!-- ä¿æŠ¤ç»“æœ -->
        <div id="protectionResults" class="protection-section" style="display:none;">
            <h2>ğŸ”’ ä¿æŠ¤ç»“æœ</h2>
            <div id="protectionStatus"></div>
            <div id="protectedData"></div>
            
            <div class="action-buttons" style="margin-top: 20px;">
                <button id="storageIngestBtn" class="btn btn-primary" style="display:none;">å­˜å‚¨å…¥åº“</button>
                <button id="viewStorageBtn" class="btn btn-info" onclick="showStorageManagement()">æŸ¥çœ‹å­˜å‚¨</button>
            </div>
        </div>

        <!-- å­˜å‚¨ç®¡ç† -->
        <div id="storageManagement" class="results-section" style="display:none;">
            <h2>ğŸ“¦ å­˜å‚¨ç®¡ç†</h2>
            
            <div class="results-tabs">
                <button class="tab-btn active" onclick="showStorageTab('storageObjects')">å­˜å‚¨å¯¹è±¡</button>
                <button class="tab-btn" onclick="showStorageTab('storageBatches')">æ‰¹æ¬¡åˆ—è¡¨</button>
                <button class="tab-btn" onclick="showStorageTab('storageStats')">ç»Ÿè®¡ä¿¡æ¯</button>
                <button class="tab-btn" onclick="showStorageTab('verificationTab')">éªŒè¯å·¥å…·</button>
            </div>

            <div id="storageObjects" class="tab-content active">
                <h3>å­˜å‚¨å¯¹è±¡åˆ—è¡¨</h3>
                <button onclick="loadStorageObjects()" class="btn btn-secondary" style="margin-bottom:15px;">åˆ·æ–°åˆ—è¡¨</button>
                <div id="storageObjectsList"></div>
            </div>

            <div id="storageBatches" class="tab-content">
                <h3>æ‰¹æ¬¡åˆ—è¡¨</h3>
                <button onclick="loadStorageBatches()" class="btn btn-secondary" style="margin-bottom:15px;">åˆ·æ–°åˆ—è¡¨</button>
                <div id="storageBatchesList"></div>
            </div>

            <div id="storageStats" class="tab-content">
                <h3>å­˜å‚¨ç»Ÿè®¡</h3>
                <button onclick="loadStorageStats()" class="btn btn-secondary" style="margin-bottom:15px;">åˆ·æ–°ç»Ÿè®¡</button>
                <div id="storageStatsDisplay"></div>
            </div>

            <div id="verificationTab" class="tab-content">
                <h3>éªŒè¯å·¥å…·</h3>
                <div class="form-group">
                    <label for="verifyPatientId">Patient ID:</label>
                    <input type="text" id="verifyPatientId" placeholder="è¾“å…¥Patient ID (å¦‚: patient00826)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px;">
                </div>
                <div class="action-buttons">
                    <button onclick="verifyRepo()" class="btn btn-primary">ä»ä»“åº“éªŒè¯</button>
                    <button onclick="buildAndVerifyBundle()" class="btn btn-success">æ„å»ºå¹¶éªŒè¯Bundle</button>
                </div>
                <div id="verificationResults" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // å•æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('singleUploadForm').onsubmit = async function(e) {
            e.preventDefault();
            await handleSingleUpload();
        };

        // æ‰¹é‡å¤„ç†
        document.getElementById('batchUploadForm').onsubmit = async function(e) {
            e.preventDefault();
            await handleBatchUpload();
        };

        // ä¿æŠ¤æŒ‰é’®
        document.getElementById('protectBtn').onclick = async function() {
            await executeProtection();
        };

        // ä¸‹è½½æŒ‰é’®
        document.getElementById('downloadBtn').onclick = function() {
            downloadResults();
        };

        // å¤„ç†å•æ–‡ä»¶ä¸Šä¼ 
        async function handleSingleUpload() {
            const formData = new FormData(document.getElementById('singleUploadForm'));
            showProgress();
            
            try {
                // å…ˆä¸Šä¼ CSVæ–‡ä»¶
                const csvResponse = await fetch('/api/upload_csv', {
                method: 'POST',
                body: formData
            });
            
                const csvResult = await csvResponse.json();
                if (csvResult.status !== 'success') {
                    showError('CSVæ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + csvResult.error);
                    return;
                }
                
                // å¦‚æœæœ‰DICOMæ–‡ä»¶ï¼Œä¹Ÿä¸Šä¼ 
                let dicomPath = null;
                const dicomFile = document.getElementById('dicom').files[0];
                if (dicomFile) {
                    const dicomFormData = new FormData();
                    dicomFormData.append('dicom', dicomFile);
                    
                    const dicomResponse = await fetch('/api/ingest', {
                        method: 'POST',
                        body: dicomFormData
                    });
                    
                    const dicomResult = await dicomResponse.json();
                    if (dicomResult.status === 'success') {
                        dicomPath = dicomResult.dicom_path;
                    }
                }
                
                // æ‰§è¡Œæ£€æµ‹
                const detectionResponse = await fetch('/api/detect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ingest_id: csvResult.csv_id,
                        csv_path: csvResult.csv_path,
                        dicom_path: dicomPath
                    })
                });
                
                const detectionResult = await detectionResponse.json();
                displayResults(detectionResult);
            } catch (error) {
                showError('å¤„ç†å¤±è´¥: ' + error.message);
            } finally {
                hideProgress();
            }
        }

        // å¤„ç†æ‰¹é‡ä¸Šä¼ ï¼ˆæ”¯æŒ1ä¸ªCSVå¯¹å¤šä¸ªDICOMçš„åœºæ™¯ï¼‰
        async function handleBatchUpload() {
            const csvFiles = document.getElementById('batchCsvFiles').files;
            const dicomFiles = document.getElementById('batchDicomFiles').files;
            
            if (csvFiles.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªCSVæ–‡ä»¶');
                return;
            }
            
            showProgress();
            updateProgress(0, `å‡†å¤‡å¤„ç†...`);
            
            try {
                // åœºæ™¯åˆ¤æ–­ï¼š1ä¸ªCSV + å¤šä¸ªDICOMï¼ˆæ‰¹é‡æ¨¡å¼ï¼‰vs å¤šä¸ªCSV + å¤šä¸ªDICOMï¼ˆé…å¯¹æ¨¡å¼ï¼‰
                if (csvFiles.length === 1 && dicomFiles.length > 1) {
                    // **æ‰¹é‡æ¨¡å¼**: 1ä¸ªCSVåŒ…å«å¤šè¡Œï¼Œæ¯è¡Œå¯¹åº”ä¸€ä¸ªDICOM
                    await handleBatchMode(csvFiles[0], dicomFiles);
                } else {
                    // **é…å¯¹æ¨¡å¼**: å¤šä¸ªCSVï¼Œæ¯ä¸ªCSVå¯¹åº”ä¸€ä¸ªDICOM
                    await handlePairMode(csvFiles, dicomFiles);
                }
                
            } catch (error) {
                alert('æ‰¹é‡å¤„ç†å¤±è´¥: ' + error.message);
                console.error(error);
            } finally {
                hideProgress();
            }
        }
        
        // æ‰¹é‡æ¨¡å¼ï¼š1ä¸ªCSVå¯¹å¤šä¸ªDICOMï¼ˆåˆ†æ‰¹ä¸Šä¼ ï¼‰
        async function handleBatchMode(csvFile, dicomFiles) {
            updateProgress(5, `è¯»å–CSVæ–‡ä»¶ ${csvFile.name}...`);
            
            // 1. è¯»å–CSVæ–‡ä»¶ï¼Œæå–æ‰€æœ‰patient_id
            const csvText = await csvFile.text();
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            
            console.log(`CSVåŒ…å« ${lines.length - 1} è¡Œæ•°æ®`);
            console.log(`DICOMæ–‡ä»¶æ•°: ${dicomFiles.length}`);
            
            // æå–æ‰€æœ‰patientä¿¡æ¯
            const csvPatients = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const pathMatch = line.match(/patient(\d+)/i);
                if (pathMatch) {
                    csvPatients.push({
                        rowIndex: i - 1,
                        patientId: 'patient' + pathMatch[1],
                        patientNumber: pathMatch[1],
                        csvLine: line
                    });
                }
            }
            
            console.log(`ä»CSVæå–åˆ° ${csvPatients.length} ä¸ªpatient_id`);
            
            // 2. åˆ†æ‰¹ä¸Šä¼ DICOMæ–‡ä»¶ï¼ˆæ¯æ‰¹100ä¸ªï¼‰
            const BATCH_SIZE = 100;
            const allMetadata = [];
            const totalBatches = Math.ceil(dicomFiles.length / BATCH_SIZE);
            
            for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                const start = batchIndex * BATCH_SIZE;
                const end = Math.min(start + BATCH_SIZE, dicomFiles.length);
                const batchFiles = Array.from(dicomFiles).slice(start, end);
                
                const progressPercent = 10 + (batchIndex / totalBatches) * 60;
                updateProgress(progressPercent, `ä¸Šä¼ DICOMæ–‡ä»¶ ${start + 1}-${end}/${dicomFiles.length}...`);
                
                // åˆ›å»ºFormData
                const dicomFormData = new FormData();
                for (let dicomFile of batchFiles) {
                    dicomFormData.append('dicom_files', dicomFile);
                }
                
                // ä¸Šä¼ è¿™ä¸€æ‰¹
                try {
                    const dicomUploadResponse = await fetch('/api/batch_upload_dicom', {
                        method: 'POST',
                        body: dicomFormData
                    });
                    
                    if (!dicomUploadResponse.ok) {
                        const errorText = await dicomUploadResponse.text();
                        console.error(`æ‰¹æ¬¡ ${batchIndex + 1} ä¸Šä¼ å¤±è´¥:`, errorText);
                        throw new Error(`DICOMæ‰¹æ¬¡ ${batchIndex + 1} ä¸Šä¼ å¤±è´¥: ${errorText}`);
                    }
                    
                    const dicomData = await dicomUploadResponse.json();
                    console.log(`æ‰¹æ¬¡ ${batchIndex + 1}/${totalBatches} ä¸Šä¼ å®Œæˆ: ${dicomData.processed} ä¸ªæ–‡ä»¶`);
                    
                    // åˆå¹¶å…ƒæ•°æ®
                    if (dicomData.metadata_list) {
                        allMetadata.push(...dicomData.metadata_list);
                    }
                } catch (error) {
                    console.error(`æ‰¹æ¬¡ ${batchIndex + 1} å¤„ç†å¤±è´¥:`, error);
                    alert(`è­¦å‘Š: æ‰¹æ¬¡ ${batchIndex + 1} å¤„ç†å¤±è´¥ï¼Œç»§ç»­å¤„ç†å…¶ä»–æ‰¹æ¬¡...`);
                }
            }
            
            console.log(`æ‰€æœ‰DICOMä¸Šä¼ å®Œæˆï¼Œå…±æå– ${allMetadata.length} ä¸ªå…ƒæ•°æ®`);
            updateProgress(75, `ä¸Šä¼ CSVå¹¶å¼€å§‹è·¨æ¨¡æ€åŒ¹é…...`);
            
            // 3. ä¸Šä¼ CSV
            const csvFormData = new FormData();
            csvFormData.append('csv_file', csvFile);
            const csvResponse = await fetch('/api/upload_csv', {method: 'POST', body: csvFormData});
            
            if (!csvResponse.ok) {
                throw new Error('CSVä¸Šä¼ å¤±è´¥');
            }
            
            const csvUploadData = await csvResponse.json();
            
            // 4. è°ƒç”¨æ‰¹é‡æ£€æµ‹API
            updateProgress(80, `æ‰§è¡Œè·¨æ¨¡æ€åŒ¹é…...`);
            const batchDetectResponse = await fetch('/api/batch_detect', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    csv_path: csvUploadData.csv_path,
                    dicom_metadata_list: allMetadata
                })
            });
            
            if (!batchDetectResponse.ok) {
                const errorText = await batchDetectResponse.text();
                throw new Error(`æ‰¹é‡æ£€æµ‹å¤±è´¥: ${errorText}`);
            }
            
            const batchResult = await batchDetectResponse.json();
            
            updateProgress(100, 'æ‰¹é‡å¤„ç†å®Œæˆï¼');
            console.log('æ‰¹é‡æ£€æµ‹ç»“æœ:', batchResult);
            console.log('Resultsæ•°ç»„é•¿åº¦:', batchResult.results ? batchResult.results.length : 'undefined');
            console.log('å‰5ä¸ªç»“æœ:', batchResult.results ? batchResult.results.slice(0, 5) : 'undefined');
            
            // æ˜¾ç¤ºç»“æœ
            displayBatchModeResults(batchResult);
        }
        
        // é…å¯¹æ¨¡å¼ï¼šå¤šä¸ªCSVå¯¹å¤šä¸ªDICOMï¼ˆåŸé€»è¾‘ä¿ç•™ï¼‰
        async function handlePairMode(csvFiles, dicomFiles) {
            const results = [];
            for (let i = 0; i < csvFiles.length; i++) {
                const csvFile = csvFiles[i];
                updateProgress((i / csvFiles.length) * 100, `å¤„ç† ${csvFile.name}...`);
                
                // ç®€å•çš„æ–‡ä»¶ååŒ¹é…
                let matchedDicom = null;
                const csvBaseName = csvFile.name.replace(/\.csv$/i, '').toLowerCase();
                for (let dicomFile of dicomFiles) {
                    const dicomBaseName = dicomFile.name.replace(/\.dcm$/i, '').toLowerCase();
                    if (csvBaseName === dicomBaseName) {
                        matchedDicom = dicomFile;
                        break;
                    }
                }
                
                results.push({
                    csv_file: csvFile.name,
                    dicom_file: matchedDicom ? matchedDicom.name : 'None',
                    result: {text_entities: [], mappings: []}
                });
            }
            
            updateProgress(100, 'å®Œæˆï¼');
            displayBatchResults(results);
        }

                // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
        function displayResults(result) {
            console.log('æ£€æµ‹ç»“æœ:', result); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            document.getElementById('results').style.display = 'block';
            
            // æ˜¾ç¤ºæ–‡æœ¬å®ä½“
            const entitiesList = document.getElementById('entitiesList');
            entitiesList.innerHTML = '';
            
            const entities = result.entities || result.text_entities || [];
            if (entities.length > 0) {
                console.log('æ£€æµ‹åˆ°å®ä½“æ•°é‡:', entities.length); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                
                // æŒ‰ç±»å‹åˆ†ç»„
                const entityGroups = {};
                entities.forEach(entity => {
                    if (!entityGroups[entity.type]) {
                        entityGroups[entity.type] = [];
                    }
                    entityGroups[entity.type].push(entity);
                });
                
                // ä¸ºæ¯ä¸ªç±»å‹åˆ›å»ºåˆ†ç»„æ˜¾ç¤º
                Object.keys(entityGroups).sort().forEach(type => {
                    const groupDiv = document.createElement('div');
                    groupDiv.style.marginBottom = '20px';
                    
                    const groupHeader = document.createElement('h4');
                    groupHeader.style.color = '#495057';
                    groupHeader.style.marginBottom = '10px';
                    groupHeader.style.fontSize = '16px';
                    groupHeader.style.fontWeight = '600';
                    
                    // æ ¹æ®ç±»å‹è®¾ç½®å›¾æ ‡
                    let icon = 'ğŸ“‹';
                    if (type === 'NAME') icon = 'ğŸ‘¤';
                    else if (type === 'AGE') icon = 'ğŸ“…';
                    else if (type === 'SEX') icon = 'âš§';
                    else if (type === 'PHONE') icon = 'ğŸ“±';
                    else if (type === 'ID') icon = 'ğŸ†”';
                    else if (type === 'ADDRESS') icon = 'ğŸ“';
                    else if (type === 'PATH') icon = 'ğŸ“';
                    
                    groupHeader.innerHTML = `${icon} ${type} <span style="color: #6c757d; font-weight: 400;">(${entityGroups[type].length})</span>`;
                    groupDiv.appendChild(groupHeader);
                    
                    entityGroups[type].forEach(entity => {
                        const entityDiv = document.createElement('div');
                        entityDiv.className = 'entity-item';
                        entityDiv.innerHTML = `
                            <span class="entity-type">${entity.type}</span>
                            <span class="entity-text">${entity.text}</span>
                            <span class="entity-confidence">ç½®ä¿¡åº¦: ${(entity.confidence * 100).toFixed(1)}%</span>
                        `;
                        groupDiv.appendChild(entityDiv);
                    });
                    
                    entitiesList.appendChild(groupDiv);
                });
            } else {
                console.log('æœªæ£€æµ‹åˆ°å®ä½“ï¼Œç»“æœ:', result); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                entitiesList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 30px;">æœªæ£€æµ‹åˆ°æ•æ„Ÿå®ä½“</p>';
            }
            
            // æ˜¾ç¤ºè·¨æ¨¡æ€å…³è”
            const crossModalList = document.getElementById('crossModalList');
            crossModalList.innerHTML = '';
            
            if (result.mappings && result.mappings.length > 0) {
                result.mappings.forEach((mapping, index) => {
                    const mappingDiv = document.createElement('div');
                    mappingDiv.className = `risk-item ${mapping.risk_level}`;
                    
                    // æ ¹æ®åŒ¹é…ç±»å‹è®¾ç½®å›¾æ ‡å’Œæ ‡é¢˜
                    let icon = 'ğŸ”—';
                    let title = 'è·¨æ¨¡æ€å…³è”';
                    if (mapping.match_type === 'patient_id_exact_match') {
                        icon = 'âœ…';
                        title = 'Patient ID å®Œå…¨åŒ¹é…';
                    } else if (mapping.match_type === 'patient_id_mismatch') {
                        icon = 'âŒ';
                        title = 'Patient ID ä¸åŒ¹é…';
                    } else if (mapping.match_type === 'name_match') {
                        icon = 'ğŸ‘¤';
                        title = 'å§“ååŒ¹é…';
                    } else if (mapping.match_type === 'age_match') {
                        icon = 'ğŸ“…';
                        title = 'å¹´é¾„åŒ¹é…';
                    } else if (mapping.match_type === 'sex_match') {
                        icon = 'âš§';
                        title = 'æ€§åˆ«åŒ¹é…';
                    }
                    
                    mappingDiv.innerHTML = `
                        <div>${icon} ${title}</div>
                        <div><strong>CSVä½ç½®:</strong> ç¬¬ <code>${mapping.csv_row}</code> è¡Œï¼Œ<code>${mapping.csv_column}</code> åˆ—</div>
                        <div><strong>CSVå€¼:</strong> <code>${mapping.csv_value}</code></div>
                        ${mapping.extracted_patient_id ? `<div><strong>æå–çš„Patient ID:</strong> <code>${mapping.extracted_patient_id}</code></div>` : ''}
                        <div><strong>DICOMå­—æ®µ:</strong> <code>${mapping.dicom_field}</code> = <code>${mapping.dicom_value}</code></div>
                        <div>
                            <strong>ç½®ä¿¡åº¦:</strong> <span style="color: ${mapping.confidence >= 0.9 ? '#28a745' : mapping.confidence >= 0.7 ? '#ffc107' : '#dc3545'}; font-weight: 700;">${(mapping.confidence * 100).toFixed(1)}%</span>
                            <span style="margin: 0 10px;">|</span>
                            <strong>é£é™©çº§åˆ«:</strong> <span class="risk-level ${mapping.risk_level}">${mapping.risk_level}</span>
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef;">
                            <strong>è¯´æ˜:</strong> ${mapping.description}
                        </div>
                    `;
                    crossModalList.appendChild(mappingDiv);
                });
            } else {
                crossModalList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 30px;">æœªå‘ç°è·¨æ¨¡æ€å…³è”</p>';
            }
            
            // æ˜¾ç¤ºè·¨æ¨¡æ€é£é™©
            if (result.cross_modal_risks && result.cross_modal_risks.length > 0) {
                result.cross_modal_risks.forEach(risk => {
                    const riskDiv = document.createElement('div');
                    riskDiv.className = 'risk-item';
                    riskDiv.innerHTML = `
                        <span class="risk-level ${risk.risk_level}">${risk.risk_level}</span>
                        <span class="risk-description">${risk.description}</span>
                    `;
                    crossModalList.appendChild(riskDiv);
                });
            }
            
            // æ˜¾ç¤ºé£é™©æŒ‡æ ‡
            if (result.metrics) {
                const riskMetrics = document.getElementById('riskMetrics');
                riskMetrics.innerHTML = `
                    <div class="metric-item">
                        <span>F1åˆ†æ•°: ${(result.metrics.f1_score * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric-item">
                        <span>å¤„ç†æ—¶é—´: ${result.metrics.processing_time.toFixed(2)}ç§’</span>
                    </div>
                    <div class="metric-item">
                        <span>é«˜é£é™©å®ä½“: ${result.metrics.high_risk_entities_count}</span>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºæ‰¹é‡æ¨¡å¼ç»“æœï¼ˆ1ä¸ªCSVå¯¹å¤šä¸ªDICOMï¼‰
        function displayBatchModeResults(data) {
            console.log('displayBatchModeResults called with:', data);
            document.getElementById('results').style.display = 'block';
            
            // ä¿å­˜æ£€æµ‹ç»“æœåˆ°å…¨å±€å˜é‡ï¼Œä¾›ä¿æŠ¤åŠŸèƒ½ä½¿ç”¨
            currentDetectionResult = data;
            currentBatchId = `batch_${Date.now()}`;
            
            // 1. å¤„ç†æ–‡æœ¬å®ä½“ - æ±‡æ€»æ‰€æœ‰CSVæ•°æ®ä¸­çš„æ•æ„Ÿä¿¡æ¯
            displayBatchTextEntities(data);
            
            // 2. å¤„ç†è·¨æ¨¡æ€å…³è” - æ˜¾ç¤ºåŒ¹é…è¯¦æƒ…
            displayBatchCrossmodalMatches(data);
            
            // 3. å½±åƒåŒºåŸŸæç¤º
            const roiDisplay = document.getElementById('roiDisplay');
            if (roiDisplay) {
                roiDisplay.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #666;">
                        <p>æ‰¹é‡å¤„ç†æ¨¡å¼ä¸‹ï¼ŒDICOMå½±åƒROIä¿¡æ¯å·²åŒ…å«åœ¨å…ƒæ•°æ®ä¸­ã€‚</p>
                        <p>å…±å¤„ç† ${data.matched} ä¸ªDICOMæ–‡ä»¶çš„å…ƒæ•°æ®ã€‚</p>
                    </div>
                `;
            }
            
            // 4. æ˜¾ç¤ºé£é™©æŒ‡æ ‡
            const riskMetrics = document.getElementById('riskMetrics');
            if (riskMetrics) {
                riskMetrics.innerHTML = `
                    <div class="metric-item">
                        <span>æ€»ç—…äººæ•°: ${data.total_patients}</span>
                    </div>
                    <div class="metric-item">
                        <span>æˆåŠŸåŒ¹é…: ${data.matched} / ${data.total_patients} (${data.match_rate.toFixed(1)}%)</span>
                    </div>
                    <div class="metric-item">
                        <span>æœªåŒ¹é…: ${data.unmatched}</span>
                    </div>
                `;
            }
            
            // é»˜è®¤åˆ‡æ¢åˆ°æ–‡æœ¬å®ä½“æ ‡ç­¾é¡µ
            showTab('textResults');
        }
        
        // æ˜¾ç¤ºæ‰¹é‡æ–‡æœ¬å®ä½“ï¼ˆæ±‡æ€»ï¼‰
        function displayBatchTextEntities(data) {
            const entitiesList = document.getElementById('entitiesList');
            
            if (!entitiesList) {
                console.error('[ERROR] entitiesListå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            if (!data || !data.results || data.results.length === 0) {
                entitiesList.innerHTML = '<p style="color: red;">é”™è¯¯ï¼šæœªæ”¶åˆ°æœ‰æ•ˆæ•°æ®</p>';
                return;
            }
            
            // æ±‡æ€»æ‰€æœ‰æ•æ„Ÿå®ä½“
            const entityGroups = {
                'NAME': { icon: 'ğŸ‘¤', entities: [] },
                'SEX': { icon: 'âš§', entities: [] },
                'AGE': { icon: 'ğŸ“…', entities: [] },
                'PHONE': { icon: 'ğŸ“±', entities: [] },
                'ID_NUMBER': { icon: 'ğŸ†”', entities: [] },
                'ADDRESS': { icon: 'ğŸ“', entities: [] },
                'PATH': { icon: 'ğŸ“', entities: [] }
            };
            
            // ä»æ‰€æœ‰åŒ¹é…ç»“æœä¸­æå–å®ä½“ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼šæœ€å¤šå¤„ç†å‰1000æ¡ï¼‰
            const processingLimit = Math.min(1000, data.results.length);
            for (let i = 0; i < processingLimit; i++) {
                const match = data.results[i];
                if (match.csv_data) {
                    const csvData = match.csv_data;
                    
                    // æå–å„ç±»å®ä½“
                    if (csvData.Name) entityGroups['NAME'].entities.push({ value: csvData.Name, row: match.row_index });
                    if (csvData.Sex) entityGroups['SEX'].entities.push({ value: csvData.Sex, row: match.row_index });
                    if (csvData.Age) entityGroups['AGE'].entities.push({ value: csvData.Age, row: match.row_index });
                    if (csvData.Phone) entityGroups['PHONE'].entities.push({ value: csvData.Phone, row: match.row_index });
                    if (csvData.ID_Number) entityGroups['ID_NUMBER'].entities.push({ value: csvData.ID_Number, row: match.row_index });
                    if (csvData.Address) entityGroups['ADDRESS'].entities.push({ value: csvData.Address, row: match.row_index });
                    if (csvData.Path) entityGroups['PATH'].entities.push({ value: csvData.Path, row: match.row_index });
                }
            }
            
            if (data.results.length > 1000) {
                console.log(`[PERF] ä»…å¤„ç†å‰1000æ¡æ•°æ®ç”¨äºæ˜¾ç¤ºï¼Œæ€»å…±${data.results.length}æ¡`);
            }
            
            let html = '<h4>æ£€æµ‹åˆ°çš„æ•æ„Ÿå®ä½“ï¼ˆæ‰¹é‡æ±‡æ€»ï¼‰</h4>';
            html += `<p style="color: #666; margin-bottom: 20px;">å…±å¤„ç† ${data.total_patients} æ¡è®°å½•ï¼ŒåŒ¹é… ${data.matched} ä¸ªDICOMæ–‡ä»¶</p>`;
            
            // æ˜¾ç¤ºæ¯ç±»å®ä½“ï¼ˆä»…æ˜¾ç¤ºå‰20æ¡ï¼‰
            for (const [entityType, group] of Object.entries(entityGroups)) {
                if (group.entities.length > 0) {
                    // å»é‡
                    const uniqueEntities = [...new Set(group.entities.map(e => String(e.value)))];
                    const displayCount = Math.min(20, group.entities.length);
                    
                    html += `
                        <div class="entity-group" style="margin-bottom: 20px;">
                            <h5 style="color: #333; margin-bottom: 10px;">
                                ${group.icon} ${entityType} (${group.entities.length} æ¡ï¼Œå»é‡å ${uniqueEntities.length} ä¸ªå”¯ä¸€å€¼)
                            </h5>
                    `;
                    
                    // æ˜¾ç¤ºå‰20æ¡
                    for (let i = 0; i < displayCount; i++) {
                        const entity = group.entities[i];
                        html += `
                            <div class="entity-item" style="margin: 8px 0;">
                                <span class="entity-type">${entityType}</span>
                                <span class="entity-text">${entity.value}</span>
                                <span class="entity-confidence">è¡Œ${entity.row + 1} | 98.0%</span>
                            </div>
                        `;
                    }
                    
                    if (group.entities.length > 20) {
                        html += `<p style="color: #999; text-align: center; margin: 10px 0;">... è¿˜æœ‰ ${group.entities.length - 20} æ¡æœªæ˜¾ç¤º ...</p>`;
                    }
                    
                    html += '</div>';
                }
            }
            
            entitiesList.innerHTML = html;
        }
        
        // æ˜¾ç¤ºæ‰¹é‡è·¨æ¨¡æ€åŒ¹é…
        function displayBatchCrossmodalMatches(data) {
            const crossmodalList = document.getElementById('crossModalList');  // æ³¨æ„å¤§å°å†™
            
            if (!crossmodalList) {
                console.error('[ERROR] crossModalListå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            if (!data || !data.total_patients) {
                crossmodalList.innerHTML = '<p style="color: red;">é”™è¯¯ï¼šæœªæ”¶åˆ°æœ‰æ•ˆæ•°æ®</p>';
                return;
            }
            
            const matchRate = data.total_patients > 0 ? (data.matched / data.total_patients * 100).toFixed(1) : 0;
            const hasResults = data.results && data.results.length > 0;
            
            let html = `
                <h4>è·¨æ¨¡æ€å…³è”æ£€æµ‹ï¼ˆæ‰¹é‡ï¼‰</h4>
                <div class="batch-summary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h4 style="color: white;">ğŸ¥ æ‰¹é‡è·¨æ¨¡æ€æ£€æµ‹å®Œæˆ</h4>
                    <p><strong>CSVæ–‡ä»¶:</strong> ${data.csv_file || 'unknown'}</p>
                    <p><strong>æ€»ç—…äººæ•°:</strong> ${data.total_patients} äºº</p>
                    <p><strong>å·²å¤„ç†:</strong> ${data.processed} äºº</p>
                    <p><strong>æˆåŠŸåŒ¹é…DICOM:</strong> ${data.matched} / ${data.total_patients} (${matchRate}%)</p>
                    <p><strong>æœªåŒ¹é…:</strong> ${data.unmatched} äºº</p>
                </div>
            `;
            
            if (hasResults) {
                html += `<div style="margin: 20px 0;"><h4>åŒ¹é…è¯¦æƒ…ï¼ˆå‰20æ¡ï¼‰:</h4></div>`;
                
                // æ˜¾ç¤ºå‰20æ¡åŒ¹é…ç»“æœï¼Œåƒå•æ–‡ä»¶ä¸€æ ·è¯¦ç»†
                const displayCount = Math.min(20, data.results.length);
                for (let i = 0; i < displayCount; i++) {
                    const item = data.results[i];
                    if (!item.matched) continue; // åªæ˜¾ç¤ºæˆåŠŸåŒ¹é…çš„
                    
                    const csvData = item.csv_data || {};
                    const dicomMeta = item.dicom_metadata || {};
                    
                    html += `
                        <div class="crossmodal-card" style="margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">
                            <h5 style="color: #333; margin-bottom: 10px;">ğŸ“‹ Patient ${item.patient_id} (CSVç¬¬${item.row_index + 1}è¡Œ)</h5>
                            
                            <div class="mapping-item" style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                                <strong style="color: #28a745;">âœ… Patient ID å®Œå…¨åŒ¹é…</strong>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>CSVä½ç½®:</strong> ç¬¬ ${item.row_index} è¡Œï¼ŒPath åˆ—<br>
                                    <strong>CSVå€¼:</strong> ${csvData.Path || 'N/A'}<br>
                                    <strong>æå–çš„Patient ID:</strong> ${item.patient_id}<br>
                                    <strong>DICOMå­—æ®µ:</strong> patient_id = ${dicomMeta.patient_id || 'N/A'}<br>
                                    <strong>ç½®ä¿¡åº¦:</strong> ${(item.confidence * 100).toFixed(1)}% | 
                                    <strong>é£é™©çº§åˆ«:</strong> <span style="color: #dc3545;">${item.risk_level || 'critical'}</span>
                                </p>
                                <p style="color: #999; font-size: 0.9em; margin: 5px 0;">
                                    è¯´æ˜: CSV Pathä¸­çš„patient_id (${item.patient_id}) ä¸ DICOM patient_id å®Œå…¨åŒ¹é…
                                </p>
                            </div>
                            
                            ${csvData.Sex && dicomMeta.patient_sex ? `
                            <div class="mapping-item" style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                                <strong style="color: #ffc107;">âš§ æ€§åˆ«åŒ¹é…</strong>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>CSVä½ç½®:</strong> ç¬¬ ${item.row_index} è¡Œï¼ŒSex åˆ—<br>
                                    <strong>CSVå€¼:</strong> ${csvData.Sex}<br>
                                    <strong>DICOMå­—æ®µ:</strong> patient_sex = ${dicomMeta.patient_sex}<br>
                                    <strong>ç½®ä¿¡åº¦:</strong> 90.0% | <strong>é£é™©çº§åˆ«:</strong> medium
                                </p>
                                <p style="color: #999; font-size: 0.9em; margin: 5px 0;">
                                    è¯´æ˜: æ€§åˆ«åŒ¹é…: ${csvData.Sex}
                                </p>
                            </div>
                            ` : ''}
                            
                            ${csvData.Age && dicomMeta.patient_age ? `
                            <div class="mapping-item" style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                                <strong style="color: #17a2b8;">ğŸ“… å¹´é¾„åŒ¹é…</strong>
                                <p style="margin: 5px 0; color: #666;">
                                    <strong>CSVå€¼:</strong> ${csvData.Age} å²<br>
                                    <strong>DICOMå€¼:</strong> ${dicomMeta.patient_age}<br>
                                    <strong>ç½®ä¿¡åº¦:</strong> 85.0% | <strong>é£é™©çº§åˆ«:</strong> medium
                                </p>
                            </div>
                            ` : ''}
                            
                            <div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 4px;">
                                <strong style="color: #856404;">âš ï¸ æ£€æµ‹åˆ°é«˜é£é™©å®ä½“:</strong>
                                ${csvData.Name ? `<span style="margin: 0 5px; color: #dc3545;">NAME</span>` : ''}
                                ${csvData.Phone ? `<span style="margin: 0 5px; color: #dc3545;">PHONE</span>` : ''}
                                ${csvData.ID_Number ? `<span style="margin: 0 5px; color: #dc3545;">ID_NUMBER</span>` : ''}
                                ${csvData.Address ? `<span style="margin: 0 5px; color: #dc3545;">ADDRESS</span>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                if (data.results.length > 20) {
                    html += `<p style="text-align: center; color: #666; margin: 20px 0;">... è¿˜æœ‰ ${data.results.length - 20} æ¡ç»“æœæœªæ˜¾ç¤º ...</p>`;
                }
            } else {
                html += '<p style="color: #dc3545;">è­¦å‘Šï¼šæœªæ‰¾åˆ°åŒ¹é…ç»“æœæ•°æ®</p>';
            }
            
            // æ·»åŠ è¯´æ˜
            html += `
                <div style="margin-top: 20px; padding: 15px; background: ${data.matched > 0 ? '#d4edda' : '#f8d7da'}; border-left: 4px solid ${data.matched > 0 ? '#28a745' : '#dc3545'}; border-radius: 4px;">
                    <h4 style="color: ${data.matched > 0 ? '#155724' : '#721c24'}; margin-bottom: 10px;">
                        ${data.matched > 0 ? 'âœ… åŒ¹é…æˆåŠŸ' : 'âš ï¸ åŒ¹é…å¤±è´¥'}
                    </h4>
                    ${data.matched > 0 ? `
                        <p style="color: #155724;">
                            ç³»ç»Ÿä»CSVçš„Pathåˆ—ä¸­æå–äº† ${data.total_patients} ä¸ªpatient_id<br>
                            ä»DICOMæ–‡ä»¶ä¸­æå–äº† ${data.matched > 0 ? 'æœ‰æ•ˆçš„' : ''} patient_id<br>
                            æˆåŠŸåŒ¹é…äº† ${data.matched} ä¸ªè·¨æ¨¡æ€å…³è”ï¼<br>
                            è·¨æ¨¡æ€å…³è”æ£€æµ‹å·²å®Œæˆã€‚
                        </p>
                    ` : `
                        <p style="color: #721c24;">
                            <strong>å¯èƒ½åŸå› ï¼š</strong><br>
                            1. DICOMå…ƒæ•°æ®ä¸­çš„patient_idä¸CSVä¸­çš„patient_idä¸åŒ¹é…<br>
                            2. DICOMæ–‡ä»¶å¯èƒ½ç¼ºå°‘patient_idå­—æ®µ<br>
                        </p>
                    `}
                </div>
            `;
            
            crossmodalList.innerHTML = html;
            console.log('Results displayed successfully in crossmodal tab');
        }
        
        // æ˜¾ç¤ºæ‰¹é‡å¤„ç†ç»“æœï¼ˆé…å¯¹æ¨¡å¼ï¼‰
        function displayBatchResults(results) {
                document.getElementById('results').style.display = 'block';
            
            const entitiesList = document.getElementById('entitiesList');
            
            // ç»Ÿè®¡ä¿¡æ¯
            let totalEntities = 0;
            let totalMappings = 0;
            let filesWithDicom = 0;
            
            results.forEach(item => {
                totalEntities += (item.result.text_entities || []).length;
                totalMappings += (item.result.mappings || []).length;
                if (item.dicom_file !== 'None') filesWithDicom++;
            });
            
            let summaryHTML = `
                <div class="batch-summary">
                    <h4>ğŸ“Š æ‰¹é‡å¤„ç†å®Œæˆ</h4>
                    <p><strong>æ–‡ä»¶æ€»æ•°:</strong> ${results.length} å¯¹</p>
                    <p><strong>åŒ¹é…DICOM:</strong> ${filesWithDicom} / ${results.length}</p>
                    <p><strong>æ£€æµ‹å®ä½“:</strong> ${totalEntities} ä¸ª</p>
                    <p><strong>è·¨æ¨¡æ€å…³è”:</strong> ${totalMappings} ä¸ª</p>
                    ${filesWithDicom === 0 ? '<p style="color: #dc3545;">âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„DICOMæ–‡ä»¶ï¼Œæ— æ³•è¿›è¡Œè·¨æ¨¡æ€æ£€æµ‹</p>' : ''}
                </div>
            `;
            
            // æ˜¾ç¤ºæ¯ä¸ªæ–‡ä»¶çš„ç»“æœæ‘˜è¦
            results.forEach((item, index) => {
                const entityCount = (item.result.text_entities || []).length;
                const mappingCount = (item.result.mappings || []).length;
                const hasDicom = item.dicom_file !== 'None';
                
                // æ ¹æ®æ˜¯å¦æœ‰DICOMè®¾ç½®è¾¹æ¡†é¢œè‰²
                const borderColor = hasDicom ? (mappingCount > 0 ? '#28a745' : '#ffc107') : '#dc3545';
                
                summaryHTML += `
                    <div class="entity-item" style="margin: 10px 0; border-left-color: ${borderColor};">
                        <span class="entity-type" style="background: ${borderColor};">#${index + 1}</span>
                        <span class="entity-text">
                            ğŸ“„ <strong>CSV:</strong> ${item.csv_file}<br>
                            ğŸ¥ <strong>DICOM:</strong> ${item.dicom_file} ${!hasDicom ? 'âŒ' : 'âœ…'}<br>
                            ğŸ“ <strong>æ£€æµ‹å®ä½“:</strong> ${entityCount} ä¸ª<br>
                            ğŸ”— <strong>è·¨æ¨¡æ€å…³è”:</strong> ${mappingCount} ä¸ª ${!hasDicom ? '(éœ€è¦DICOMæ–‡ä»¶)' : ''}
                        </span>
                        <span class="entity-confidence">
                            ${item.result.metrics && item.result.metrics.f1_score 
                                ? 'F1: ' + (item.result.metrics.f1_score * 100).toFixed(1) + '%' 
                                : (hasDicom ? 'N/A' : 'æ— DICOM')}
                        </span>
                    </div>
                `;
            });
            
            // æ·»åŠ è¯´æ˜
            summaryHTML += `
                <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
                    <h4 style="color: #1976D2; margin-bottom: 10px;">ğŸ’¡ æ–‡ä»¶åŒ¹é…è¯´æ˜</h4>
                    <p style="margin: 5px 0; color: #555;">ç³»ç»Ÿä¼šè‡ªåŠ¨æ ¹æ®æ–‡ä»¶ååŒ¹é…CSVå’ŒDICOMï¼š</p>
                    <ul style="margin: 10px 0; padding-left: 20px; color: #555;">
                        <li><code>patient001.csv</code> â†” <code>patient001.dcm</code></li>
                        <li><code>study_001.csv</code> â†” <code>study_001.dcm</code></li>
                        <li>æˆ–CSVä¸­çš„Pathåˆ—åŒ…å«çš„patient_idä¸DICOMæ–‡ä»¶ååŒ¹é…</li>
                    </ul>
                    <p style="margin: 5px 0; color: #555;">
                        ${filesWithDicom === 0 
                            ? 'âš ï¸ <strong>å»ºè®®:</strong> è¯·ç¡®ä¿CSVå’ŒDICOMæ–‡ä»¶åæœ‰ç›¸åŒçš„æ ‡è¯†ç¬¦' 
                            : 'âœ… å·²æˆåŠŸåŒ¹é… ' + filesWithDicom + ' å¯¹æ–‡ä»¶'}
                    </p>
                </div>
            `;
            
            entitiesList.innerHTML = summaryHTML;
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // å…¨å±€å˜é‡ï¼šä¿å­˜å½“å‰æ£€æµ‹ç»“æœå’Œæ‰¹æ¬¡ID
        let currentDetectionResult = null;
        let currentBatchId = null;

        // æ‰§è¡Œä¿æŠ¤
        async function executeProtection() {
            const protectBtn = document.getElementById('protectBtn');
            protectBtn.disabled = true;
            protectBtn.textContent = 'æ­£åœ¨ä¿æŠ¤...';
            
            try {
                if (!currentDetectionResult) {
                    showError('è¯·å…ˆæ‰§è¡Œæ‰¹é‡æ£€æµ‹');
                    return;
                }
                
                updateProgress(10, 'å¼€å§‹æ‰§è¡Œä¿æŠ¤...');
                showProgress();
                
                // è°ƒç”¨ä¿æŠ¤API
                const response = await fetch('/api/protect_execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        detection_result: currentDetectionResult,
                        batch_id: currentBatchId
                    })
                });
                
                updateProgress(60, 'ä¿æŠ¤ä¸­...');
                
                const result = await response.json();
                
                if (result.batch_id) {
                    currentBatchId = result.batch_id;
                    updateProgress(100, 'ä¿æŠ¤å®Œæˆï¼');
                    
                    document.getElementById('protectionResults').style.display = 'block';
                    document.getElementById('protectionStatus').innerHTML = `
                        <div class="protection-success">
                            <h3>âœ… ä¿æŠ¤å®Œæˆ</h3>
                            <p><strong>æ‰¹æ¬¡ID:</strong> ${result.batch_id}</p>
                            <p><strong>ä¿æŠ¤æ•°é‡:</strong> ${result.protected_count} ä¸ªå¯¹è±¡</p>
                            <p><strong>å¯†é’¥æç¤º:</strong> ${result.key_hint}</p>
                            <p><strong>è¾“å‡ºDICOM:</strong> ${result.output_dicom}</p>
                            <p><strong>è¾“å‡ºæ–‡æœ¬:</strong> ${result.output_text}</p>
                            <p><strong>å®¡è®¡æ¸…å•:</strong> ${result.audit_manifest}</p>
                        </div>
                    `;
                    
                    // æ˜¾ç¤ºå…¥åº“æŒ‰é’®
                    document.getElementById('storageIngestBtn').style.display = 'inline-flex';
                    document.getElementById('storageIngestBtn').onclick = function() {
                        storageIngest(currentBatchId);
                    };
                    
                    document.getElementById('protectionResults').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showError('ä¿æŠ¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showError('ä¿æŠ¤è¿‡ç¨‹å‡ºé”™: ' + error.message);
            } finally {
                hideProgress();
                protectBtn.disabled = false;
                protectBtn.textContent = 'æ‰§è¡Œä¿æŠ¤';
            }
        }

        // å­˜å‚¨å…¥åº“
        async function storageIngest(batchId) {
            try {
                updateProgress(10, 'å¼€å§‹å­˜å‚¨å…¥åº“...');
                showProgress();
                
                const response = await fetch('/api/storage/ingest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        batch_id: batchId
                    })
                });
                
                updateProgress(60, 'å…¥åº“ä¸­...');
                
                const result = await response.json();
                
                if (result.batch_id) {
                    updateProgress(100, 'å…¥åº“å®Œæˆï¼');
                    alert(`å…¥åº“æˆåŠŸï¼\næ‰¹æ¬¡ID: ${result.batch_id}\nå…¥åº“æ•°é‡: ${result.ingested}\nå®¡è®¡SHA256: ${result.audit_sha256}`);
                } else {
                    showError('å…¥åº“å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showError('å…¥åº“è¿‡ç¨‹å‡ºé”™: ' + error.message);
            } finally {
                hideProgress();
            }
        }

        // æ˜¾ç¤ºå­˜å‚¨ç®¡ç†
        function showStorageManagement() {
            document.getElementById('storageManagement').style.display = 'block';
            document.getElementById('storageManagement').scrollIntoView({ behavior: 'smooth' });
            loadStorageObjects();
        }

        // å­˜å‚¨æ ‡ç­¾é¡µåˆ‡æ¢
        function showStorageTab(tabName) {
            const tabContents = document.querySelectorAll('#storageManagement .tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            const tabBtns = document.querySelectorAll('#storageManagement .tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));
            
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            if (window.event && window.event.target) {
                window.event.target.classList.add('active');
            }
        }

        // åŠ è½½å­˜å‚¨å¯¹è±¡
        async function loadStorageObjects() {
            try {
                const response = await fetch('/api/storage/list?limit=20&offset=0');
                const result = await response.json();
                
                const list = document.getElementById('storageObjectsList');
                if (result.objects && result.objects.length > 0) {
                    let html = '<div class="entity-group">';
                    result.objects.forEach(obj => {
                        html += `
                            <div class="entity-item">
                                <span class="entity-type">ID#${obj.id}</span>
                                <span class="entity-text">
                                    <strong>Patient:</strong> ${obj.patient_id}<br>
                                    <strong>SOP:</strong> ${obj.sop_uid || 'N/A'}<br>
                                    <strong>Batch:</strong> ${obj.batch_id}<br>
                                    <strong>DICOM SHA256:</strong> ${obj.dicom_sha256.substring(0, 16)}...
                                </span>
                                <span class="entity-confidence">${new Date(obj.timestamp).toLocaleString()}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    list.innerHTML = html;
                } else {
                    list.innerHTML = '<p style="text-align:center; color:#666;">æš‚æ— å­˜å‚¨å¯¹è±¡</p>';
                }
            } catch (error) {
                document.getElementById('storageObjectsList').innerHTML = `<p style="color:red;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        // åŠ è½½æ‰¹æ¬¡åˆ—è¡¨
        async function loadStorageBatches() {
            try {
                const response = await fetch('/api/storage/batches?limit=20');
                const result = await response.json();
                
                const list = document.getElementById('storageBatchesList');
                if (result.batches && result.batches.length > 0) {
                    let html = '<div class="entity-group">';
                    result.batches.forEach(batch => {
                        html += `
                            <div class="entity-item">
                                <span class="entity-type">BATCH</span>
                                <span class="entity-text">
                                    <strong>ID:</strong> ${batch.batch_id}<br>
                                    <strong>å¯¹è±¡æ•°:</strong> ${batch.count || 'N/A'}<br>
                                    <strong>å®¡è®¡SHA256:</strong> ${batch.audit_sha256 ? batch.audit_sha256.substring(0, 16) + '...' : 'N/A'}<br>
                                    <strong>ç­¾å:</strong> ${batch.has_signature ? 'âœ… å·²ç­¾å' : 'âŒ æœªç­¾å'}
                                </span>
                                <span class="entity-confidence">${new Date(batch.timestamp).toLocaleString()}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    list.innerHTML = html;
                } else {
                    list.innerHTML = '<p style="text-align:center; color:#666;">æš‚æ— æ‰¹æ¬¡</p>';
                }
            } catch (error) {
                document.getElementById('storageBatchesList').innerHTML = `<p style="color:red;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        // åŠ è½½å­˜å‚¨ç»Ÿè®¡
        async function loadStorageStats() {
            try {
                const response = await fetch('/api/storage/stats');
                const result = await response.json();
                
                const display = document.getElementById('storageStatsDisplay');
                display.innerHTML = `
                    <div class="batch-summary">
                        <h4>ğŸ“Š å­˜å‚¨ç»Ÿè®¡</h4>
                        <p><strong>æ€»å¯¹è±¡æ•°:</strong> ${result.total_objects}</p>
                        <p><strong>æ€»æ‰¹æ¬¡æ•°:</strong> ${result.total_batches}</p>
                        <p><strong>ä»“åº“è·¯å¾„:</strong> ${result.repo_path}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('storageStatsDisplay').innerHTML = `<p style="color:red;">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        // ä»ä»“åº“éªŒè¯
        async function verifyRepo() {
            const patientId = document.getElementById('verifyPatientId').value.trim();
            if (!patientId) {
                alert('è¯·è¾“å…¥Patient ID');
                return;
            }
            
            try {
                const response = await fetch('/api/verify/repo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_id: patientId
                    })
                });
                
                const result = await response.json();
                displayVerificationResults(result, 'ä»“åº“éªŒè¯');
            } catch (error) {
                alert('éªŒè¯å¤±è´¥: ' + error.message);
            }
        }

        // æ„å»ºå¹¶éªŒè¯Bundle
        async function buildAndVerifyBundle() {
            const patientId = document.getElementById('verifyPatientId').value.trim();
            if (!patientId) {
                alert('è¯·è¾“å…¥Patient ID');
                return;
            }
            
            try {
                // å…ˆæ„å»ºbundle
                const buildResp = await fetch('/api/storage/bundle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_id: patientId
                    })
                });
                
                const buildResult = await buildResp.json();
                
                if (buildResult.status !== 'success') {
                    alert('æ„å»ºBundleå¤±è´¥: ' + (buildResult.error || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }
                
                // å†éªŒè¯bundle
                const verifyResp = await fetch('/api/verify/bundle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        patient_id: patientId
                    })
                });
                
                const verifyResult = await verifyResp.json();
                displayVerificationResults(verifyResult, 'BundleéªŒè¯', buildResult.bundle_path);
                
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºéªŒè¯ç»“æœ
        function displayVerificationResults(result, title, bundlePath) {
            const display = document.getElementById('verificationResults');
            
            let html = `<h4>${title}ç»“æœ</h4>`;
            
            if (result.error) {
                html += `<div class="risk-item high"><p style="color:red;">é”™è¯¯: ${result.error}</p></div>`;
            } else {
                // ç­¾åéªŒè¯
                if (result.sig_ok !== null) {
                    html += `
                        <div class="risk-item ${result.sig_ok ? 'low' : 'high'}">
                            <h5>${result.sig_ok ? 'âœ…' : 'âŒ'} SPHINCS+ç­¾åéªŒè¯</h5>
                            <p><strong>çŠ¶æ€:</strong> ${result.sig_ok ? 'é€šè¿‡' : 'å¤±è´¥'}</p>
                        </div>
                    `;
                }
                
                // å¯¹éªŒè¯ç»“æœ
                if (result.pair) {
                    const issues = result.pair.issues || [];
                    html += `
                        <div class="risk-item ${issues.length === 0 ? 'low' : 'medium'}">
                            <h5>ğŸ“‹ DICOM-JSONå¯¹éªŒè¯</h5>
                            <p><strong>DICOM:</strong> ${result.pair.dicom}</p>
                            <p><strong>JSON:</strong> ${result.pair.text}</p>
                            <p><strong>é—®é¢˜æ•°:</strong> ${issues.length}</p>
                            ${issues.length > 0 ? `<p><strong>é—®é¢˜:</strong> ${issues.join('; ')}</p>` : '<p style="color:green;">âœ… æ— é—®é¢˜</p>'}
                        </div>
                    `;
                    
                    // Headerä¿¡æ¯
                    if (result.pair.headers) {
                        html += `<div class="risk-item low"><h5>ğŸ“ DICOM Header</h5>`;
                        for (const [key, val] of Object.entries(result.pair.headers)) {
                            html += `<p><strong>${key}:</strong> ${val}</p>`;
                        }
                        html += `</div>`;
                    }
                }
                
                // Bundleè·¯å¾„
                if (bundlePath) {
                    html += `
                        <div class="risk-item low">
                            <h5>ğŸ“¦ Bundleä½ç½®</h5>
                            <p><strong>è·¯å¾„:</strong> ${bundlePath}</p>
                            <a href="/api/storage/bundle/${document.getElementById('verifyPatientId').value}/download" 
                               class="btn btn-success" style="margin-top:10px;">ä¸‹è½½Bundle</a>
                        </div>
                    `;
                }
            }
            
            display.innerHTML = html;
        }

        // æ˜¾ç¤ºè¿›åº¦
        function showProgress() {
            document.getElementById('progress').style.display = 'block';
            updateProgress(0, 'å¼€å§‹å¤„ç†...');
        }

        // éšè—è¿›åº¦
        function hideProgress() {
            document.getElementById('progress').style.display = 'none';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            alert('é”™è¯¯: ' + message);
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®ï¼ˆå¦‚æœæ˜¯ä»æŒ‰é’®ç‚¹å‡»è§¦å‘çš„ï¼‰
            if (window.event && window.event.target) {
                window.event.target.classList.add('active');
            } else {
                // ç¨‹åºåŒ–è°ƒç”¨æ—¶ï¼Œæ ¹æ®tabNameæ‰¾åˆ°å¯¹åº”æŒ‰é’®
                const tabNameMap = {
                    'textResults': 'æ–‡æœ¬å®ä½“',
                    'imageResults': 'å½±åƒåŒºåŸŸ',
                    'crossModalResults': 'è·¨æ¨¡æ€å…³è”',
                    'riskAssessment': 'é£é™©è¯„ä¼°'
                };
                const btnText = tabNameMap[tabName];
                if (btnText) {
                    tabBtns.forEach(btn => {
                        if (btn.textContent === btnText) {
                            btn.classList.add('active');
                        }
                    });
                }
            }
        }

        // ä¸‹è½½ç»“æœ
        function downloadResults() {
            // å®é™…åº”ç”¨ä¸­åº”è¯¥ç”Ÿæˆå¹¶ä¸‹è½½ç»“æœæ–‡ä»¶
            alert('ä¸‹è½½åŠŸèƒ½å¾…å®ç°');
        }
    </script>
</body>
</html>