<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»ç–—éšç§ä¿æŠ¤ç³»ç»Ÿ - è·¨æ¨¡æ€æ£€æµ‹</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/dicom-parser@1.8.3/dist/dicomParser.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>åŒ»ç–—éšç§ä¿æŠ¤ç³»ç»Ÿ</h1>
            <p>åŸºäºæ³¨æ„åŠ›æœºåˆ¶çš„è·¨æ¨¡æ€éšç§å…³è”æ£€æµ‹</p>
        </header>

        <div class="upload-section">
            <h2>æ•°æ®ä¸Šä¼ </h2>
            
            <!-- å•æ–‡ä»¶ä¸Šä¼ æ¨¡å¼ -->
            <div class="upload-mode">
                <h3>å•æ–‡ä»¶å¤„ç†</h3>
                <form id="singleUploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="csvFile">è¯Šæ–­æŠ¥å‘ŠCSVæ–‡ä»¶:</label>
                        <input type="file" id="csvFile" name="csv" accept=".csv" required />
                        <small>è¯·ä¸Šä¼ åŒ…å«è¯Šæ–­æŠ¥å‘Šçš„CSVæ–‡ä»¶</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="dicom">DICOMæ–‡ä»¶:</label>
                        <input type="file" id="dicom" name="dicom" accept=".dcm" />
                        <small>å¯é€‰ï¼šä¸Šä¼ å¯¹åº”çš„DICOMæ–‡ä»¶</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">ä¸Šä¼ å¹¶æ£€æµ‹</button>
                </form>
            </div>

            <!-- æ‰¹é‡å¤„ç†æ¨¡å¼ -->
            <div class="upload-mode">
                <h3>æ‰¹é‡å¤„ç†</h3>
                <form id="batchUploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="csvFile">CSVæ–‡ä»¶:</label>
                        <input type="file" id="csvFile" name="csv" accept=".csv" required />
                        <small>è¯·ä¸Šä¼ åŒ…å«è¯Šæ–­æ–‡æœ¬çš„CSVæ–‡ä»¶</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="dicomDir">DICOMæ–‡ä»¶ç›®å½•:</label>
                        <input type="file" id="dicomDir" name="dicom_dir" webkitdirectory directory multiple accept=".dcm" />
                        <small>è¯·é€‰æ‹©åŒ…å«DICOMæ–‡ä»¶çš„ç›®å½•</small>
                    </div>
                    
                    <button type="submit" class="btn btn-secondary">æ‰¹é‡å¤„ç†</button>
                </form>
            </div>
        </div>

        <!-- å¤„ç†è¿›åº¦ -->
        <div id="progress" class="progress-section" style="display:none;">
            <h3>å¤„ç†è¿›åº¦</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">æ­£åœ¨å¤„ç†...</p>
        </div>

        <!-- æ£€æµ‹ç»“æœ -->
        <div id="results" class="results-section" style="display:none;">
            <h2>æ£€æµ‹ç»“æœ</h2>
            
            <div class="results-tabs">
                <button class="tab-btn active" onclick="showTab('textResults')">æ–‡æœ¬å®ä½“</button>
                <button class="tab-btn" onclick="showTab('imageResults')">å½±åƒåŒºåŸŸ</button>
                <button class="tab-btn" onclick="showTab('crossModalResults')">è·¨æ¨¡æ€å…³è”</button>
                <button class="tab-btn" onclick="showTab('riskAssessment')">é£é™©è¯„ä¼°</button>
            </div>

            <div id="textResults" class="tab-content active">
                <h3>æ£€æµ‹åˆ°çš„æ•æ„Ÿå®ä½“</h3>
                <div id="entitiesList"></div>
            </div>

            <div id="imageResults" class="tab-content">
                <h3>å½±åƒROIåŒºåŸŸ</h3>
                <div id="roiDisplay"></div>
            </div>

            <div id="crossModalResults" class="tab-content">
                <h3>è·¨æ¨¡æ€å…³è”æ£€æµ‹</h3>
                <div id="crossModalList"></div>
            </div>

            <div id="riskAssessment" class="tab-content">
                <h3>é£é™©è¯„ä¼°</h3>
                <div id="riskMetrics"></div>
            </div>

            <div class="action-buttons">
                <button id="protectBtn" class="btn btn-success">æ‰§è¡Œä¿æŠ¤</button>
                <button id="downloadBtn" class="btn btn-info">ä¸‹è½½ç»“æœ</button>
            </div>
        </div>

        <!-- ä¿æŠ¤ç»“æœ -->
        <div id="protectionResults" class="protection-section" style="display:none;">
            <h2>ä¿æŠ¤ç»“æœ</h2>
            <div id="protectionStatus"></div>
            <div id="protectedData"></div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // å•æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('singleUploadForm').onsubmit = async function(e) {
            e.preventDefault();
            await handleSingleUpload();
        };

        // æ‰¹é‡å¤„ç†
        document.getElementById('batchUploadForm').onsubmit = async function(e) {
            e.preventDefault();
            await handleBatchUpload();
        };

        // ä¿æŠ¤æŒ‰é’®
        document.getElementById('protectBtn').onclick = async function() {
            await executeProtection();
        };

        // ä¸‹è½½æŒ‰é’®
        document.getElementById('downloadBtn').onclick = function() {
            downloadResults();
        };

        // å¤„ç†å•æ–‡ä»¶ä¸Šä¼ 
        async function handleSingleUpload() {
            const formData = new FormData(document.getElementById('singleUploadForm'));
            showProgress();
            
            try {
                // å…ˆä¸Šä¼ CSVæ–‡ä»¶
                const csvResponse = await fetch('/api/upload_csv', {
                    method: 'POST',
                    body: formData
                });
                
                const csvResult = await csvResponse.json();
                if (csvResult.status !== 'success') {
                    showError('CSVæ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + csvResult.error);
                    return;
                }
                
                // å¦‚æœæœ‰DICOMæ–‡ä»¶ï¼Œä¹Ÿä¸Šä¼ 
                let dicomPath = null;
                const dicomFile = document.getElementById('dicom').files[0];
                if (dicomFile) {
                    const dicomFormData = new FormData();
                    dicomFormData.append('dicom', dicomFile);
                    
                    const dicomResponse = await fetch('/api/ingest', {
                        method: 'POST',
                        body: dicomFormData
                    });
                    
                    const dicomResult = await dicomResponse.json();
                    if (dicomResult.status === 'success') {
                        dicomPath = dicomResult.dicom_path;
                    }
                }
                
                // æ‰§è¡Œæ£€æµ‹
                const detectionResponse = await fetch('/api/detect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ingest_id: csvResult.csv_id,
                        csv_path: csvResult.csv_path,
                        dicom_path: dicomPath
                    })
                });
                
                const detectionResult = await detectionResponse.json();
                displayResults(detectionResult);
            } catch (error) {
                showError('å¤„ç†å¤±è´¥: ' + error.message);
            } finally {
                hideProgress();
            }
        }

        // å¤„ç†æ‰¹é‡ä¸Šä¼ 
        async function handleBatchUpload() {
            const csvFile = document.getElementById('csvFile').files[0];
            const dicomFiles = document.getElementById('dicomDir').files;
            
            if (!csvFile || dicomFiles.length === 0) {
                showError('è¯·é€‰æ‹©CSVæ–‡ä»¶å’ŒDICOMæ–‡ä»¶ç›®å½•');
                return;
            }
            
            showProgress();
            
            try {
                // ä¸Šä¼ CSVæ–‡ä»¶
                const csvFormData = new FormData();
                csvFormData.append('csv', csvFile);
                
                const csvResponse = await fetch('/api/upload_csv', {
                    method: 'POST',
                    body: csvFormData
                });
                
                const csvResult = await csvResponse.json();
                
                if (csvResult.status === 'success') {
                    // ä¸Šä¼ DICOMæ–‡ä»¶
                    const dicomFormData = new FormData();
                    for (let file of dicomFiles) {
                        dicomFormData.append('dicom_files', file);
                    }
                    
                    const dicomResponse = await fetch('/api/upload_dicom', {
                        method: 'POST',
                        body: dicomFormData
                    });
                    
                    const dicomResult = await dicomResponse.json();
                    
                    if (dicomResult.status === 'success') {
                        // æ‰§è¡Œæ‰¹é‡å¤„ç†
                        const batchResponse = await fetch('/api/process_batch', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                csv_path: csvResult.csv_path,
                                dicom_dir: dicomResult.dicom_dir
                            })
                        });
                        
                        const batchResult = await batchResponse.json();
                        displayBatchResults(batchResult);
                    } else {
                        showError('DICOMæ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + dicomResult.error);
                    }
                } else {
                    showError('CSVæ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + csvResult.error);
                }
            } catch (error) {
                showError('æ‰¹é‡å¤„ç†å¤±è´¥: ' + error.message);
            } finally {
                hideProgress();
            }
        }

        // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
        function displayResults(result) {
            console.log('æ£€æµ‹ç»“æœ:', result); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            document.getElementById('results').style.display = 'block';
            
            // æ˜¾ç¤ºæ–‡æœ¬å®ä½“
            const entitiesList = document.getElementById('entitiesList');
            entitiesList.innerHTML = '';
            
            const entities = result.entities || result.text_entities || [];
            if (entities.length > 0) {
                console.log('æ£€æµ‹åˆ°å®ä½“æ•°é‡:', entities.length); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                
                // æŒ‰ç±»å‹åˆ†ç»„
                const entityGroups = {};
                entities.forEach(entity => {
                    if (!entityGroups[entity.type]) {
                        entityGroups[entity.type] = [];
                    }
                    entityGroups[entity.type].push(entity);
                });
                
                // ä¸ºæ¯ä¸ªç±»å‹åˆ›å»ºåˆ†ç»„æ˜¾ç¤º
                Object.keys(entityGroups).sort().forEach(type => {
                    const groupDiv = document.createElement('div');
                    groupDiv.style.marginBottom = '20px';
                    
                    const groupHeader = document.createElement('h4');
                    groupHeader.style.color = '#495057';
                    groupHeader.style.marginBottom = '10px';
                    groupHeader.style.fontSize = '16px';
                    groupHeader.style.fontWeight = '600';
                    
                    // æ ¹æ®ç±»å‹è®¾ç½®å›¾æ ‡
                    let icon = 'ğŸ“‹';
                    if (type === 'NAME') icon = 'ğŸ‘¤';
                    else if (type === 'AGE') icon = 'ğŸ“…';
                    else if (type === 'SEX') icon = 'âš§';
                    else if (type === 'PHONE') icon = 'ğŸ“±';
                    else if (type === 'ID') icon = 'ğŸ†”';
                    else if (type === 'ADDRESS') icon = 'ğŸ“';
                    else if (type === 'PATH') icon = 'ğŸ“';
                    
                    groupHeader.innerHTML = `${icon} ${type} <span style="color: #6c757d; font-weight: 400;">(${entityGroups[type].length})</span>`;
                    groupDiv.appendChild(groupHeader);
                    
                    entityGroups[type].forEach(entity => {
                        const entityDiv = document.createElement('div');
                        entityDiv.className = 'entity-item';
                        entityDiv.innerHTML = `
                            <span class="entity-type">${entity.type}</span>
                            <span class="entity-text">${entity.text}</span>
                            <span class="entity-confidence">ç½®ä¿¡åº¦: ${(entity.confidence * 100).toFixed(1)}%</span>
                        `;
                        groupDiv.appendChild(entityDiv);
                    });
                    
                    entitiesList.appendChild(groupDiv);
                });
            } else {
                console.log('æœªæ£€æµ‹åˆ°å®ä½“ï¼Œç»“æœ:', result); // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                entitiesList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 30px;">æœªæ£€æµ‹åˆ°æ•æ„Ÿå®ä½“</p>';
            }
            
            // æ˜¾ç¤ºè·¨æ¨¡æ€å…³è”
            const crossModalList = document.getElementById('crossModalList');
            crossModalList.innerHTML = '';
            
            if (result.mappings && result.mappings.length > 0) {
                result.mappings.forEach((mapping, index) => {
                    const mappingDiv = document.createElement('div');
                    mappingDiv.className = `risk-item ${mapping.risk_level}`;
                    
                    // æ ¹æ®åŒ¹é…ç±»å‹è®¾ç½®å›¾æ ‡å’Œæ ‡é¢˜
                    let icon = 'ğŸ”—';
                    let title = 'è·¨æ¨¡æ€å…³è”';
                    if (mapping.match_type === 'patient_id_exact_match') {
                        icon = 'âœ…';
                        title = 'Patient ID å®Œå…¨åŒ¹é…';
                    } else if (mapping.match_type === 'patient_id_mismatch') {
                        icon = 'âŒ';
                        title = 'Patient ID ä¸åŒ¹é…';
                    } else if (mapping.match_type === 'name_match') {
                        icon = 'ğŸ‘¤';
                        title = 'å§“ååŒ¹é…';
                    } else if (mapping.match_type === 'age_match') {
                        icon = 'ğŸ“…';
                        title = 'å¹´é¾„åŒ¹é…';
                    } else if (mapping.match_type === 'sex_match') {
                        icon = 'âš§';
                        title = 'æ€§åˆ«åŒ¹é…';
                    }
                    
                    mappingDiv.innerHTML = `
                        <div>${icon} ${title}</div>
                        <div><strong>CSVä½ç½®:</strong> ç¬¬ <code>${mapping.csv_row}</code> è¡Œï¼Œ<code>${mapping.csv_column}</code> åˆ—</div>
                        <div><strong>CSVå€¼:</strong> <code>${mapping.csv_value}</code></div>
                        ${mapping.extracted_patient_id ? `<div><strong>æå–çš„Patient ID:</strong> <code>${mapping.extracted_patient_id}</code></div>` : ''}
                        <div><strong>DICOMå­—æ®µ:</strong> <code>${mapping.dicom_field}</code> = <code>${mapping.dicom_value}</code></div>
                        <div>
                            <strong>ç½®ä¿¡åº¦:</strong> <span style="color: ${mapping.confidence >= 0.9 ? '#28a745' : mapping.confidence >= 0.7 ? '#ffc107' : '#dc3545'}; font-weight: 700;">${(mapping.confidence * 100).toFixed(1)}%</span>
                            <span style="margin: 0 10px;">|</span>
                            <strong>é£é™©çº§åˆ«:</strong> <span class="risk-level ${mapping.risk_level}">${mapping.risk_level}</span>
                        </div>
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef;">
                            <strong>è¯´æ˜:</strong> ${mapping.description}
                        </div>
                    `;
                    crossModalList.appendChild(mappingDiv);
                });
            } else {
                crossModalList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 30px;">æœªå‘ç°è·¨æ¨¡æ€å…³è”</p>';
            }
            
            // æ˜¾ç¤ºè·¨æ¨¡æ€é£é™©
            if (result.cross_modal_risks && result.cross_modal_risks.length > 0) {
                result.cross_modal_risks.forEach(risk => {
                    const riskDiv = document.createElement('div');
                    riskDiv.className = 'risk-item';
                    riskDiv.innerHTML = `
                        <span class="risk-level ${risk.risk_level}">${risk.risk_level}</span>
                        <span class="risk-description">${risk.description}</span>
                    `;
                    crossModalList.appendChild(riskDiv);
                });
            }
            
            // æ˜¾ç¤ºé£é™©æŒ‡æ ‡
            if (result.metrics) {
                const riskMetrics = document.getElementById('riskMetrics');
                riskMetrics.innerHTML = `
                    <div class="metric-item">
                        <span>F1åˆ†æ•°: ${(result.metrics.f1_score * 100).toFixed(1)}%</span>
                    </div>
                    <div class="metric-item">
                        <span>å¤„ç†æ—¶é—´: ${result.metrics.processing_time.toFixed(2)}ç§’</span>
                    </div>
                    <div class="metric-item">
                        <span>é«˜é£é™©å®ä½“: ${result.metrics.high_risk_entities_count}</span>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºæ‰¹é‡å¤„ç†ç»“æœ
        function displayBatchResults(result) {
            document.getElementById('results').style.display = 'block';
            
            const entitiesList = document.getElementById('entitiesList');
            entitiesList.innerHTML = `
                <div class="batch-summary">
                    <h4>æ‰¹é‡å¤„ç†å®Œæˆ</h4>
                    <p>å¤„ç†æ•°é‡: ${result.processed_count}</p>
                    <p>åŒ¹é…æ•°é‡: ${result.matched_count}</p>
                    <p>è¾“å‡ºè·¯å¾„: ${result.output_path}</p>
                </div>
            `;
        }

        // æ‰§è¡Œä¿æŠ¤
        async function executeProtection() {
            const protectBtn = document.getElementById('protectBtn');
            protectBtn.disabled = true;
            protectBtn.textContent = 'æ­£åœ¨ä¿æŠ¤...';
            
            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨ä¿æŠ¤API
                const response = await fetch('/api/protect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: 'current_session' // å®é™…åº”ç”¨ä¸­åº”è¯¥ä»å½“å‰ä¼šè¯è·å–
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    document.getElementById('protectionResults').style.display = 'block';
                    document.getElementById('protectionStatus').innerHTML = `
                        <div class="protection-success">
                            <h3>ä¿æŠ¤å®Œæˆ</h3>
                            <p>ä¼šè¯ID: ${result.artifact_id}</p>
                            <p>ä¿æŠ¤çŠ¶æ€: æˆåŠŸ</p>
                        </div>
                    `;
                } else {
                    showError('ä¿æŠ¤å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                showError('ä¿æŠ¤è¿‡ç¨‹å‡ºé”™: ' + error.message);
            } finally {
                protectBtn.disabled = false;
                protectBtn.textContent = 'æ‰§è¡Œä¿æŠ¤';
            }
        }

        // æ˜¾ç¤ºè¿›åº¦
        function showProgress() {
            document.getElementById('progress').style.display = 'block';
            updateProgress(0, 'å¼€å§‹å¤„ç†...');
        }

        // éšè—è¿›åº¦
        function hideProgress() {
            document.getElementById('progress').style.display = 'none';
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            alert('é”™è¯¯: ' + message);
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
            event.target.classList.add('active');
        }

        // ä¸‹è½½ç»“æœ
        function downloadResults() {
            // å®é™…åº”ç”¨ä¸­åº”è¯¥ç”Ÿæˆå¹¶ä¸‹è½½ç»“æœæ–‡ä»¶
            alert('ä¸‹è½½åŠŸèƒ½å¾…å®ç°');
        }
    </script>
</body>
</html>