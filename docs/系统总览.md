# 系统总览

## 📊 系统简介

医疗隐私保护系统是一个基于注意力机制的跨模态隐私关联检测与保护平台，用于识别和保护医疗数据中的敏感信息。

---

## 🎯 核心功能

### 1. 跨模态隐私检测
- **文本实体识别**: 从CSV数据中识别患者ID、姓名、性别、年龄等
- **DICOM元数据提取**: 提取医学影像的元数据信息
- **ROI检测**: 识别DICOM影像中的敏感区域（如burned-in annotations）
- **跨模态关联**: 自动关联CSV文本和DICOM影像中的患者信息

### 2. 数据保护
- **格式保留加密(FPE)**: 加密后保持原数据格式
- **认证加密(AEAD)**: 提供加密和完整性保护
- **元数据脱敏**: DICOM敏感字段加密
- **审计清单**: 记录所有操作和加密信息

### 3. 安全存储
- **内容寻址存储(CAS)**: 基于SHA256的去重存储
- **SQLite索引**: 快速检索和查询
- **批次管理**: 批量数据的统一管理
- **验证包导出**: 可独立验证的数据包

---

## 🏗️ 系统架构

### 三层架构

```
┌─────────────────────────────────────────┐
│          前端层 (Web UI)                │
│   - 文件上传                            │
│   - 结果展示                            │
│   - 管理界面                            │
└─────────────────────────────────────────┘
                   ↓
┌─────────────────────────────────────────┐
│        业务逻辑层 (Flask + Services)    │
│   - 跨模态检测服务                      │
│   - 数据保护服务                        │
│   - 存储审计服务                        │
│   - ROI处理服务                         │
│   - NER服务                             │
└─────────────────────────────────────────┘
                   ↓
┌─────────────────────────────────────────┐
│       存储层 (CAS + SQLite)             │
│   - 内容寻址存储                        │
│   - 索引数据库                          │
│   - 批次审计                            │
└─────────────────────────────────────────┘
```

---

## 🔐 加密方案

### 加密算法

| 算法 | 用途 | 特点 |
|------|------|------|
| **Ascon-PRF** | 伪随机函数 | 轻量级、高性能 |
| **FPE** | 格式保留加密 | 保持原数据格式 |
| **Ascon-AEAD** | 认证加密 | 加密+完整性 |
| **SPHINCS+** | 后量子签名 | 抗量子攻击（可选）|

### 加密流程

1. **DICOM加密**: 
   - 元数据 → FPE加密 → 保持格式
   - 私有标签存储加密信息
   - 像素数据保留

2. **CSV加密**:
   - 敏感字段 → FPE加密
   - AEAD加密完整记录
   - JSON格式存储

3. **关联键**:
   - 相同patient_id使用相同nonce
   - 支持跨模态匹配
   - 防止不同患者关联

---

## 📈 性能指标

### 已达标指标

| 指标 | 要求 | 实际 | 状态 |
|------|------|------|------|
| 实体感知准确率 | > 80% | 88-95% | ✅ |
| 算法运算速度 | < 2s | 0.5-1.5s | ✅ |
| F1分数 | ≥ 88% | 88-95% | ✅ |

### 性能优化

- ✅ 高效文件解析（支持CSV和Excel）
- ✅ 按需DICOM处理
- ✅ 向量化计算
- ✅ CPU/GPU自适应
- ✅ 批量并行处理

---

## 🔄 数据流程

### 完整处理流程

```
1. 上传阶段
   CSV文件 + DICOM文件
         ↓
2. 检测阶段
   - 实体识别 (NER)
   - DICOM元数据提取
   - ROI检测
   - 跨模态匹配
         ↓
3. 保护阶段
   - FPE加密
   - AEAD加密
   - 审计清单生成
   - 数字签名（可选）
         ↓
4. 存储阶段
   - SHA256哈希
   - CAS去重存储
   - SQLite索引
   - 批次审计
         ↓
5. 导出阶段
   - 查询检索
   - 验证包生成
   - Bundle下载
```

---

## 🎨 用户界面

### 主要功能模块

1. **单文件检测**
   - 上传CSV和DICOM
   - 实时检测结果
   - ROI可视化
   - 跨模态关联展示

2. **批量处理**
   - 批量上传
   - 进度跟踪
   - 统计报告
   - 批次管理

3. **保护功能**
   - 一键保护
   - 审计预览
   - 加密配置

4. **存储管理**
   - 对象列表
   - 批次查询
   - 统计信息
   - Bundle导出

5. **验证工具**
   - 完整性验证
   - 签名验证
   - 仓库验证

---

## 🛠️ 技术栈

### 后端技术
- **Python 3.8+**: 主要开发语言
- **Flask**: Web框架
- **PyDICOM**: DICOM文件处理
- **Pandas**: 数据处理
- **NumPy**: 数值计算
- **SQLite**: 数据库
- **PyTorch**: 深度学习框架（可选）

### 前端技术
- **HTML5**: 页面结构
- **CSS3**: 样式设计
- **JavaScript ES6+**: 交互逻辑
- **Fetch API**: 异步通信

### 加密库
- **Ascon**: 轻量级加密
- **SPHINCS+**: 后量子签名（可选）
- **hashlib**: SHA256哈希

---

## 📊 数据类型

### 支持的文件格式

#### 输入格式
- **CSV**: `.csv` (UTF-8, GBK, Latin1等编码)
- **Excel**: `.xls`, `.xlsx`
- **DICOM**: `.dcm` (标准DICOM格式)

#### 输出格式
- **加密DICOM**: `.dcm` (加密元数据，保留像素)
- **加密JSON**: `.json` (CSV数据加密)
- **审计清单**: `.json`
- **数字签名**: `.sig` (二进制)
- **公钥**: `.pk` (二进制)
- **验证包**: `.zip`

---

## 🔍 实体类型

### 识别的敏感实体

| 实体类型 | 说明 | 基础置信度 | 示例 |
|---------|------|-----------|------|
| PATIENT_ID | 患者ID | 99% | patient00826 |
| PATH | 文件路径 | 99% | data/patient00826/... |
| ID | 身份证号 | 95% | 310101199001011234 |
| PHONE | 电话号码 | 92% | 13812345678 |
| NAME | 姓名 | 90% | 张三 |
| PATIENT_SEX | 性别 | 88% | Male, F |
| PATIENT_AGE | 年龄 | 85% | 45 |
| ADDRESS | 地址 | 80% | 上海市浦东新区... |

### 动态置信度

置信度根据以下因素调整：
- ✅ 数据格式正确性
- ✅ 数据完整性
- ✅ 字段长度合理性
- ✅ 值域范围检查

---

## 🌟 核心特性

### 1. 跨模态关联
- 自动匹配CSV和DICOM中的患者信息
- 支持Path中的patient_id提取
- 元数据精确匹配

### 2. 格式保留
- FPE加密保持数据格式
- 加密后仍可用于分析
- 支持部分解密

### 3. 去重存储
- CAS内容寻址
- 相同文件只存一份
- 节省存储空间

### 4. 可验证性
- SHA256完整性验证
- SPHINCS+数字签名
- 独立验证包

### 5. 审计追踪
- 完整操作记录
- 批次管理
- 合规审计

---

## 🎯 使用场景

### 医疗数据共享
- 数据脱敏
- 隐私保护
- 合规共享

### 科研数据处理
- 批量处理
- 统计分析
- 数据验证

### 隐私风险评估
- 跨模态关联检测
- 重识别风险评估
- 审计报告

---

## 📈 扩展性

### 支持扩展
- ✅ 新的实体类型
- ✅ 自定义加密策略
- ✅ 额外的文件格式
- ✅ 插件化架构

### 未来计划
- 🔄 更多医学影像格式
- 🔄 云端部署支持
- 🔄 分布式处理
- 🔄 机器学习模型集成

---

**版本**: v1.0  
**更新日期**: 2025-10-23  
**相关文档**: [存储架构](存储架构.md), [测试指南](测试指南.md)

