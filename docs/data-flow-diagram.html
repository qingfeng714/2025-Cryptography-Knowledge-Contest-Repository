<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Privacy Protection System - Data Flow Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        nav {
            background: #f8f9fa;
            padding: 20px 40px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            border-bottom: 3px solid #e9ecef;
        }

        nav button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: white;
            color: #495057;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        nav button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102,126,234,0.4);
        }

        nav button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .content {
            padding: 40px;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        h3 {
            color: #6c757d;
            margin: 30px 0 15px 0;
        }

        .diagram-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .mermaid {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .code-block {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
        }

        .code-block pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        footer {
            background: #f8f9fa;
            padding: 30px 40px;
            text-align: center;
            color: #6c757d;
            border-top: 3px solid #e9ecef;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 0 5px;
        }

        .badge-primary { background: #e7f3ff; color: #0066cc; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ” Medical Privacy Protection System</h1>
            <p>Cross-modal Privacy Association Detection Based on Attention Mechanism - Data Flow Visualization</p>
            <p style="font-size:0.9em; opacity:0.8;">ğŸ“– See also: <a href="README.md" style="color:white;">README</a> | <a href="DATA_FLOW_GUIDE.md" style="color:white;">Detailed Guide</a> | <a href="DATA_FLOW_VISUALIZATION.md" style="color:white;">Visualization MD</a></p>
        </header>

        <nav>
            <button class="active" onclick="showSection('overview')">ğŸ“Š æ¶æ„æ€»è§ˆ</button>
            <button onclick="showSection('flow')">ğŸ”„ å®Œæ•´æµç¨‹</button>
            <button onclick="showSection('encryption')">ğŸ” åŠ å¯†æµç¨‹</button>
            <button onclick="showSection('storage')">ğŸ’¾ å­˜å‚¨æ¶æ„</button>
            <button onclick="showSection('api')">âš™ï¸ APIæ˜ å°„</button>
            <button onclick="showSection('stats')">ğŸ“ˆ æ€§èƒ½ç»Ÿè®¡</button>
            <button onclick="showSection('data')">ğŸ“ çœŸå®æ•°æ®</button>
        </nav>

        <div class="content">
            <!-- æ¶æ„æ€»è§ˆ -->
            <div id="overview" class="section active">
                <h2>ğŸ“Š ç³»ç»Ÿæ¶æ„æ€»è§ˆ</h2>
                
                <div class="info-box">
                    <strong>ğŸ¯ æ ¸å¿ƒæµç¨‹ï¼š</strong>ä¸Šä¼  â†’ æ£€æµ‹ â†’ ä¿æŠ¤ â†’ å…¥åº“ â†’ æŸ¥è¯¢
                </div>

                <div class="diagram-container">
                    <h3>å››å±‚æ¶æ„</h3>
                    <div class="mermaid">
graph TB
    A[å‰ç«¯å±‚<br/>index.html + main.js] --> B[APIå±‚<br/>Flask app.py]
    B --> C[æœåŠ¡å±‚<br/>services/*]
    C --> D[å­˜å‚¨å±‚<br/>storage_repo/]
    
    style A fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    style B fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style C fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style D fill:#fce4ec,stroke:#880e4f,stroke-width:2px
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">703</div>
                        <div class="stat-label">å¤„ç†æ–‡ä»¶æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">100%</div>
                        <div class="stat-label">åŒ¹é…æˆåŠŸç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">70ç§’</div>
                        <div class="stat-label">æ€»å¤„ç†æ—¶é—´</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">350MB</div>
                        <div class="stat-label">æ•°æ®å­˜å‚¨é‡</div>
                    </div>
                </div>

                <h3>æ ¸å¿ƒæŠ€æœ¯æ ˆ</h3>
                <table>
                    <tr>
                        <th>å±‚çº§</th>
                        <th>æŠ€æœ¯</th>
                        <th>åŠŸèƒ½</th>
                    </tr>
                    <tr>
                        <td>å‰ç«¯</td>
                        <td>HTML5 + JavaScript + Fetch API</td>
                        <td>æ–‡ä»¶ä¸Šä¼ ã€ç»“æœå±•ç¤ºã€ç”¨æˆ·äº¤äº’</td>
                    </tr>
                    <tr>
                        <td>åç«¯</td>
                        <td>Python 3.8+ + Flask</td>
                        <td>APIæœåŠ¡ã€ä¸šåŠ¡é€»è¾‘ã€æ•°æ®å¤„ç†</td>
                    </tr>
                    <tr>
                        <td>æœåŠ¡</td>
                        <td>PyDICOM + Pandas + PyTorch</td>
                        <td>DICOMå¤„ç†ã€CSVè§£æã€è·¨æ¨¡æ€åŒ¹é…</td>
                    </tr>
                    <tr>
                        <td>åŠ å¯†</td>
                        <td>Ascon-PRF + Ascon-AEAD + SPHINCS+</td>
                        <td>æ ¼å¼ä¿ç•™åŠ å¯†ã€è®¤è¯åŠ å¯†ã€æ•°å­—ç­¾å</td>
                    </tr>
                    <tr>
                        <td>å­˜å‚¨</td>
                        <td>CAS + SQLite</td>
                        <td>å†…å®¹å¯»å€å­˜å‚¨ã€å¿«é€Ÿç´¢å¼•</td>
                    </tr>
                </table>
            </div>

            <!-- å®Œæ•´æµç¨‹ -->
            <div id="flow" class="section">
                <h2>ğŸ”„ å®Œæ•´æ•°æ®æµç¨‹</h2>

                <div class="diagram-container">
                    <h3>5æ­¥æ ¸å¿ƒæµç¨‹</h3>
                    <div class="mermaid">
graph TB
    A[ğŸ“¤ æ­¥éª¤1: ä¸Šä¼ <br/>CSV + DICOM] --> B[ğŸ” æ­¥éª¤2: æ£€æµ‹<br/>è·¨æ¨¡æ€åŒ¹é…]
    B --> C[ğŸ” æ­¥éª¤3: ä¿æŠ¤<br/>FPE + AEAD]
    C --> D[ğŸ’¾ æ­¥éª¤4: å…¥åº“<br/>CAS + SQLite]
    D --> E[âœ… æ­¥éª¤5: æŸ¥è¯¢<br/>éªŒè¯ç®¡ç†]
    
    style A fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    style B fill:#fff9c4,stroke:#f57f17,stroke-width:3px
    style C fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px
    style D fill:#fce4ec,stroke:#c2185b,stroke-width:3px
    style E fill:#e8f5e9,stroke:#388e3c,stroke-width:3px
                    </div>
                </div>

                <div class="diagram-container">
                    <h3>å•ä¸ªæ‚£è€…æ•°æ®æµï¼ˆpatient00001ï¼‰</h3>
                    <div class="mermaid">
graph LR
    A1[CSVç¬¬0è¡Œ<br/>Name: å¼ ä¸‰<br/>Age: 35] --> B1{è·¨æ¨¡æ€åŒ¹é…}
    A2[DICOM<br/>PatientID: patient00001] --> B1
    
    B1 -->|matched=true| C1[é£é™©æ ‡è®°<br/>critical]
    C1 --> D1[AEADåŠ å¯†DICOM]
    C1 --> D2[FPEåŠ å¯†CSV]
    D1 --> E1[patient00001.dcm]
    D2 --> E2[patient00001.json]
    E1 --> F1[SHA256å“ˆå¸Œ]
    E2 --> F2[SHA256å“ˆå¸Œ]
    F1 --> G[CASå­˜å‚¨]
    F2 --> G
    G --> H[SQLiteç´¢å¼•]
    
    style A1 fill:#e3f2fd
    style A2 fill:#e3f2fd
    style B1 fill:#fff9c4
    style C1 fill:#ffccbc
    style E1 fill:#c8e6c9
    style E2 fill:#c8e6c9
    style G fill:#fce4ec
    style H fill:#fce4ec
                    </div>
                </div>

                <h3>è¯¦ç»†æ­¥éª¤è¯´æ˜</h3>
                
                <div class="success-box">
                    <strong>æ­¥éª¤1: ä¸Šä¼ æ•°æ®</strong><br/>
                    â€¢ CSVæ–‡ä»¶ï¼š703è¡Œæ‚£è€…æ•°æ®<br/>
                    â€¢ DICOMæ–‡ä»¶ï¼š703ä¸ªåŒ»å­¦å½±åƒï¼ˆåˆ†æ‰¹ä¸Šä¼ ï¼Œæ¯æ‰¹100ä¸ªï¼‰<br/>
                    â€¢ å­˜å‚¨ä½ç½®ï¼šuploads/ç›®å½•
                </div>

                <div class="info-box">
                    <strong>æ­¥éª¤2: è·¨æ¨¡æ€æ£€æµ‹</strong><br/>
                    â€¢ CSVæå–ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–patient_id<br/>
                    â€¢ DICOMæå–ï¼šä½¿ç”¨pydicomæå–å…ƒæ•°æ®<br/>
                    â€¢ ç²¾ç¡®åŒ¹é…ï¼šCSV patient_id â†” DICOM PatientID<br/>
                    â€¢ ç»“æœï¼š703ä¸ªç²¾ç¡®åŒ¹é…ï¼Œ0ä¸ªæœªåŒ¹é…
                </div>

                <div class="warning-box">
                    <strong>æ­¥éª¤3: æ•°æ®ä¿æŠ¤</strong><br/>
                    â€¢ AEADåŠ å¯†ï¼šDICOMå½±åƒæ•°æ®ï¼ˆè®¤è¯åŠ å¯†ï¼‰<br/>
                    â€¢ FPEåŠ å¯†ï¼šCSVè¯Šæ–­æŠ¥å‘Šæ‰€æœ‰æ•æ„Ÿå­—æ®µï¼ˆæ ¼å¼ä¿ç•™ï¼‰<br/>
                    â€¢ å®¡è®¡æ¸…å•ï¼šç”ŸæˆSHA256å“ˆå¸Œå’Œæ‰¹æ¬¡ä¿¡æ¯<br/>
                    â€¢ è¾“å‡ºä½ç½®ï¼šoutput/batch_*/protected_*
                </div>

                <div class="info-box">
                    <strong>æ­¥éª¤4: å­˜å‚¨å…¥åº“</strong><br/>
                    â€¢ CASå­˜å‚¨ï¼šåŸºäºSHA256çš„å»é‡å­˜å‚¨<br/>
                    â€¢ SQLiteç´¢å¼•ï¼šobjectsè¡¨ï¼ˆ703æ¡ï¼‰+ batchesè¡¨ï¼ˆ1æ¡ï¼‰<br/>
                    â€¢ å®¡è®¡ææ–™ï¼šå¤åˆ¶åˆ°storage_repo/batches/<br/>
                    â€¢ å»é‡æ•ˆæœï¼šç›¸åŒæ–‡ä»¶åªå­˜å‚¨ä¸€æ¬¡
                </div>

                <div class="success-box">
                    <strong>æ­¥éª¤5: æŸ¥è¯¢éªŒè¯</strong><br/>
                    â€¢ å¯¹è±¡æŸ¥è¯¢ï¼šGET /api/storage/list<br/>
                    â€¢ ç»Ÿè®¡ä¿¡æ¯ï¼šGET /api/storage/stats<br/>
                    â€¢ å®Œæ•´æ€§éªŒè¯ï¼šSHA256æ ¡éªŒ<br/>
                    â€¢ Bundleå¯¼å‡ºï¼šZIPæ‰“åŒ…ä¸‹è½½
                </div>
            </div>

            <!-- åŠ å¯†æµç¨‹ -->
            <div id="encryption" class="section">
                <h2>ğŸ” æ•°æ®åŠ å¯†æµç¨‹</h2>

                <div class="diagram-container">
                    <h3>åŠ å¯†ç®—æ³•æµç¨‹</h3>
                    <div class="mermaid">
graph LR
    subgraph "æ˜æ–‡æ•°æ®"
        A1[Name: å¼ ä¸‰]
        A2[Age: 35]
        A3[Phone: 138xxx]
    end
    
    subgraph "åŠ å¯†å¤„ç†"
        B1[FPE<br/>æ ¼å¼ä¿ç•™]
        B2[AEAD<br/>è®¤è¯åŠ å¯†]
    end
    
    subgraph "åŠ å¯†è¾“å‡º"
        C1[Token: ZHANGSAN]
        C2[Token: 35]
        C3[cipher_b64]
        C4[hash: sha256]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B1
    
    B1 --> C1
    B1 --> C2
    
    A1 --> B2
    A2 --> B2
    A3 --> B2
    
    B2 --> C3
    B2 --> C4
    
    style B1 fill:#fff9c4
    style B2 fill:#fff9c4
    style C1 fill:#c8e6c9
    style C2 fill:#c8e6c9
    style C3 fill:#ffccbc
    style C4 fill:#ffccbc
                    </div>
                </div>

                <h3>åŠ å¯†å‰åå¯¹æ¯”</h3>
                
                <table>
                    <tr>
                        <th>å­—æ®µ</th>
                        <th>åŸå§‹æ•°æ®</th>
                        <th>FPE Token</th>
                        <th>AEADå¯†æ–‡</th>
                    </tr>
                    <tr>
                        <td>patient_id</td>
                        <td>patient00001</td>
                        <td>QB7RN37E8V2G6</td>
                        <td>YXNjb25fYWVhZF9...</td>
                    </tr>
                    <tr>
                        <td>Name</td>
                        <td>å¼ ä¸‰</td>
                        <td>ZHANGSAN</td>
                        <td>ZW5jcnlwdGVkX1...</td>
                    </tr>
                    <tr>
                        <td>Sex</td>
                        <td>Male</td>
                        <td>N</td>
                        <td>c2V4X2VuY3J5cH...</td>
                    </tr>
                    <tr>
                        <td>Age</td>
                        <td>35</td>
                        <td>67</td>
                        <td>YWdlX2VuY3J5cH...</td>
                    </tr>
                    <tr>
                        <td>Phone</td>
                        <td>13812345678</td>
                        <td>13812TOKEN</td>
                        <td>cGhvbmVfZW5jcn...</td>
                    </tr>
                </table>

                <h3>åŠ å¯†ç®—æ³•è¯¦è§£</h3>

                <div class="warning-box">
                    <strong>ğŸ”’ AEAD (Authenticated Encryption with Associated Data)</strong><br/>
                    â€¢ åŸºäºï¼šAscon AEADç®—æ³•<br/>
                    â€¢ ç‰¹ç‚¹ï¼šåŒæ—¶æä¾›åŠ å¯†å’Œå®Œæ•´æ€§éªŒè¯<br/>
                    â€¢ ç”¨é€”ï¼šDICOMå½±åƒæ•°æ®ã€åŒ»å­¦å›¾åƒ<br/>
                    â€¢ è¾“å‡ºï¼šcipher_b64 + hash + nonce + ad
                </div>

                <div class="info-box">
                    <strong>ğŸ” FPE (Format-Preserving Encryption)</strong><br/>
                    â€¢ åŸºäºï¼šAscon-PRFä¼ªéšæœºå‡½æ•°<br/>
                    â€¢ ç‰¹ç‚¹ï¼šä¿æŒåŸæ•°æ®æ ¼å¼å’Œé•¿åº¦<br/>
                    â€¢ ç”¨é€”ï¼šCSVè¯Šæ–­æŠ¥å‘Šã€æ•æ„Ÿæ–‡æœ¬å­—æ®µ<br/>
                    â€¢ ç¤ºä¾‹ï¼š"patient00001" â†’ "QB7RN37E8V2G6"ï¼Œ"å¼ ä¸‰" â†’ "ZHANGSAN"
                </div>

                <div class="success-box">
                    <strong>âœï¸ SPHINCS+ (æ•°å­—ç­¾åï¼Œå¯é€‰)</strong><br/>
                    â€¢ ç±»å‹ï¼šåé‡å­ç­¾åç®—æ³•<br/>
                    â€¢ ç‰¹ç‚¹ï¼šæŠ—é‡å­è®¡ç®—æœºæ”»å‡»<br/>
                    â€¢ ç”¨é€”ï¼šå®¡è®¡æ¸…å•ç­¾å<br/>
                    â€¢ æ–‡ä»¶ï¼šaudit_manifest.sig + audit_manifest.pk
                </div>
            </div>

            <!-- å­˜å‚¨æ¶æ„ -->
            <div id="storage" class="section">
                <h2>ğŸ’¾ å­˜å‚¨æ¶æ„</h2>

                <div class="diagram-container">
                    <h3>æ–‡ä»¶ç³»ç»Ÿæµè½¬</h3>
                    <div class="mermaid">
graph TB
    subgraph "è¾“å…¥ (uploads/)"
        A1[csv_91151eea.csv]
        A2[batch_f68f84bd/<br/>703ä¸ª.dcm]
    end
    
    subgraph "ä¿æŠ¤è¾“å‡º (output/batch_*/)"
        C1[protected_dicom/<br/>703ä¸ªåŠ å¯†.dcm]
        C2[protected_text/<br/>703ä¸ª.json<br/>audit_manifest.json]
    end
    
    subgraph "å­˜å‚¨ä»“åº“ (storage_repo/)"
        D1[cas/<br/>1406ä¸ªæ–‡ä»¶<br/>SHA256å‘½å]
        D2[db/index.sqlite<br/>703æ¡records]
        D3[batches/<br/>å®¡è®¡ææ–™]
    end
    
    A1 --> C2
    A2 --> C1
    C1 --> D1
    C2 --> D1
    C2 --> D2
    C2 --> D3
    
    style A1 fill:#e3f2fd
    style A2 fill:#e3f2fd
    style C1 fill:#f3e5f5
    style C2 fill:#f3e5f5
    style D1 fill:#fce4ec
    style D2 fill:#fce4ec
    style D3 fill:#fce4ec
                    </div>
                </div>

                <h3>CASï¼ˆå†…å®¹å¯»å€å­˜å‚¨ï¼‰åŸç†</h3>

                <div class="code-block">
                    <pre>
# è®¡ç®—æ–‡ä»¶SHA256
sha256 = hashlib.sha256(file_content).hexdigest()
# ç¤ºä¾‹ï¼šabc123def456789...

# å­˜å‚¨è·¯å¾„è§„åˆ™
cas_path = storage_repo/cas/ab/c123def456789...
                          â†‘  â†‘
                      å‰2ä½ å‰©ä½™éƒ¨åˆ†

# ç‰¹ç‚¹
âœ… å»é‡ï¼šç›¸åŒå†…å®¹åªå­˜ä¸€æ¬¡
âœ… å®Œæ•´æ€§ï¼šæ–‡ä»¶å=å“ˆå¸Œï¼Œæ— æ³•ç¯¡æ”¹
âœ… å¯éªŒè¯ï¼šé‡æ–°è®¡ç®—SHA256å³å¯éªŒè¯
                    </pre>
                </div>

                <h3>æ•°æ®åº“è¡¨ç»“æ„</h3>

                <table>
                    <tr>
                        <th>è¡¨å</th>
                        <th>å­—æ®µ</th>
                        <th>è¯´æ˜</th>
                    </tr>
                    <tr>
                        <td rowspan="8">objects</td>
                        <td>id</td>
                        <td>ä¸»é”®ï¼Œè‡ªå¢</td>
                    </tr>
                    <tr>
                        <td>patient_id</td>
                        <td>æ‚£è€…IDï¼ˆåŠ å¯†åï¼‰</td>
                    </tr>
                    <tr>
                        <td>sop_uid</td>
                        <td>DICOM SOP UID</td>
                    </tr>
                    <tr>
                        <td>dicom_sha256</td>
                        <td>DICOMæ–‡ä»¶å“ˆå¸Œ</td>
                    </tr>
                    <tr>
                        <td>text_sha256</td>
                        <td>JSONæ–‡ä»¶å“ˆå¸Œ</td>
                    </tr>
                    <tr>
                        <td>batch_id</td>
                        <td>æ‰¹æ¬¡IDï¼ˆå¤–é”®ï¼‰</td>
                    </tr>
                    <tr>
                        <td>ts_ms</td>
                        <td>æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰</td>
                    </tr>
                    <tr>
                        <td>dicom_cas, text_cas</td>
                        <td>CASå­˜å‚¨è·¯å¾„</td>
                    </tr>
                    <tr>
                        <td rowspan="5">batches</td>
                        <td>id</td>
                        <td>æ‰¹æ¬¡IDï¼ˆä¸»é”®ï¼‰</td>
                    </tr>
                    <tr>
                        <td>audit_sha256</td>
                        <td>å®¡è®¡æ¸…å•å“ˆå¸Œ</td>
                    </tr>
                    <tr>
                        <td>sig_sha256</td>
                        <td>ç­¾åæ–‡ä»¶å“ˆå¸Œ</td>
                    </tr>
                    <tr>
                        <td>count</td>
                        <td>å¯¹è±¡æ•°é‡</td>
                    </tr>
                    <tr>
                        <td>ts_ms</td>
                        <td>æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰</td>
                    </tr>
                </table>
            </div>

            <!-- APIæ˜ å°„ -->
            <div id="api" class="section">
                <h2>âš™ï¸ APIç«¯ç‚¹æ˜ å°„</h2>

                <table>
                    <tr>
                        <th>ç«¯ç‚¹</th>
                        <th>æ–¹æ³•</th>
                        <th>åŠŸèƒ½</th>
                        <th>è¾“å…¥</th>
                        <th>è¾“å‡º</th>
                    </tr>
                    <tr>
                        <td>/api/upload_csv</td>
                        <td><span class="badge badge-warning">POST</span></td>
                        <td>ä¸Šä¼ CSVæ–‡ä»¶</td>
                        <td>csv_file (multipart)</td>
                        <td>csv_id, csv_path</td>
                    </tr>
                    <tr>
                        <td>/api/batch_upload_dicom</td>
                        <td><span class="badge badge-warning">POST</span></td>
                        <td>æ‰¹é‡ä¸Šä¼ DICOM</td>
                        <td>dicom_files[] (multipart)</td>
                        <td>dicom_id, metadata_list</td>
                    </tr>
                    <tr>
                        <td>/api/batch_detect</td>
                        <td><span class="badge badge-warning">POST</span></td>
                        <td>è·¨æ¨¡æ€æ£€æµ‹</td>
                        <td>csv_path, dicom_metadata_list (JSON)</td>
                        <td>results[], matched, unmatched</td>
                    </tr>
                    <tr>
                        <td>/api/protect_execute</td>
                        <td><span class="badge badge-warning">POST</span></td>
                        <td>æ‰§è¡Œä¿æŠ¤</td>
                        <td>detection_result, batch_id (JSON)</td>
                        <td>batch_id, protected_count</td>
                    </tr>
                    <tr>
                        <td>/api/storage/ingest</td>
                        <td><span class="badge badge-warning">POST</span></td>
                        <td>å­˜å‚¨å…¥åº“</td>
                        <td>batch_id (JSON)</td>
                        <td>batch_id, ingested</td>
                    </tr>
                    <tr>
                        <td>/api/storage/list</td>
                        <td><span class="badge badge-primary">GET</span></td>
                        <td>æŸ¥è¯¢å¯¹è±¡</td>
                        <td>limit, offset (query params)</td>
                        <td>objects[]</td>
                    </tr>
                    <tr>
                        <td>/api/storage/batches</td>
                        <td><span class="badge badge-primary">GET</span></td>
                        <td>æ‰¹æ¬¡åˆ—è¡¨</td>
                        <td>limit (query param)</td>
                        <td>batches[]</td>
                    </tr>
                    <tr>
                        <td>/api/storage/stats</td>
                        <td><span class="badge badge-primary">GET</span></td>
                        <td>å­˜å‚¨ç»Ÿè®¡</td>
                        <td>-</td>
                        <td>total_objects, total_batches</td>
                    </tr>
                    <tr>
                        <td>/api/storage/bundle</td>
                        <td><span class="badge badge-warning">POST</span></td>
                        <td>æ„å»ºBundleåŒ…</td>
                        <td>patient_id (JSON)</td>
                        <td>bundle_path, status</td>
                    </tr>
                    <tr>
                        <td>/api/storage/bundle/&lt;patient_id&gt;/download</td>
                        <td><span class="badge badge-success">GET</span></td>
                        <td>ä¸‹è½½BundleåŒ…</td>
                        <td>patient_id (URLå‚æ•°)</td>
                        <td>ZIPæ–‡ä»¶æµ</td>
                    </tr>
                    <tr>
                        <td>/api/verify/bundle</td>
                        <td><span class="badge badge-warning">POST</span></td>
                        <td>éªŒè¯Bundleå®Œæ•´æ€§</td>
                        <td>patient_id (JSON)</td>
                        <td>sig_ok, pairéªŒè¯ç»“æœ</td>
                    </tr>
                    <tr>
                        <td>/api/verify/repo</td>
                        <td><span class="badge badge-warning">POST</span></td>
                        <td>ä»ä»“åº“éªŒè¯å¯¹è±¡</td>
                        <td>patient_id (JSON)</td>
                        <td>éªŒè¯ç»“æœ, headers</td>
                    </tr>
                    <tr>
                        <td>/api/key_info</td>
                        <td><span class="badge badge-primary">GET</span></td>
                        <td>è·å–å¯†é’¥ä¿¡æ¯</td>
                        <td>-</td>
                        <td>key_hint, key_length</td>
                    </tr>
                </table>

                <h3>APIè°ƒç”¨ç¤ºä¾‹</h3>

                <div class="code-block">
                    <pre>
// 1. ä¸Šä¼ CSV
const csvResponse = await fetch('/api/upload_csv', {
    method: 'POST',
    body: formData  // {csv_file: File}
});
// â†’ {csv_id: "csv_91151eea", csv_path: "uploads/csv_91151eea.csv"}

// 2. æ‰¹é‡ä¸Šä¼ DICOM
const dicomResponse = await fetch('/api/batch_upload_dicom', {
    method: 'POST',
    body: dicomFormData  // {dicom_files: [File, File, ...]}
});
// â†’ {dicom_id: "batch_f68f84bd", metadata_list: [{patient_id, ...}, ...]}

// 3. è·¨æ¨¡æ€æ£€æµ‹
const detectResponse = await fetch('/api/batch_detect', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
        csv_path: "uploads/csv_91151eea.csv",
        dicom_metadata_list: metadataList
    })
});
// â†’ {results: [{patient_id, matched, csv_data, dicom_metadata}, ...]}

// 4. æ‰§è¡Œä¿æŠ¤
const protectResponse = await fetch('/api/protect_execute', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
        detection_result: detectionResult,
        batch_id: "batch_1761195469190"
    })
});
// â†’ {batch_id, protected_count, output_dicom, output_text}

// 5. å­˜å‚¨å…¥åº“
const storageResponse = await fetch('/api/storage/ingest', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({batch_id: "batch_1761195469190"})
});
// â†’ {batch_id, ingested: 703}

// 6. æŸ¥è¯¢å¯¹è±¡
const listResponse = await fetch('/api/storage/list?limit=20&offset=0');
// â†’ {objects: [{id, patient_id, dicom_sha256, ...}, ...]}
                    </pre>
                </div>
            </div>

            <!-- æ€§èƒ½ç»Ÿè®¡ -->
            <div id="stats" class="section">
                <h2>ğŸ“ˆ æ€§èƒ½ç»Ÿè®¡</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">703</div>
                        <div class="stat-label">æ–‡ä»¶æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">70ç§’</div>
                        <div class="stat-label">æ€»å¤„ç†æ—¶é—´</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">100%</div>
                        <div class="stat-label">åŒ¹é…æˆåŠŸç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">352MB</div>
                        <div class="stat-label">å­˜å‚¨å¤§å°</div>
                    </div>
                </div>

                <h3>å¤„ç†æ—¶é—´åˆ†å¸ƒ</h3>
                <table>
                    <tr>
                        <th>é˜¶æ®µ</th>
                        <th>è€—æ—¶</th>
                        <th>å æ¯”</th>
                        <th>è¯´æ˜</th>
                    </tr>
                    <tr>
                        <td>DICOMä¸Šä¼ </td>
                        <td>25ç§’</td>
                        <td>25%</td>
                        <td>åˆ†æ‰¹ä¸Šä¼ ï¼Œæ¯æ‰¹100ä¸ª</td>
                    </tr>
                    <tr>
                        <td>å…ƒæ•°æ®æå–</td>
                        <td>30ç§’</td>
                        <td>30%</td>
                        <td>pydicomè§£æDICOM Header</td>
                    </tr>
                    <tr>
                        <td>è·¨æ¨¡æ€åŒ¹é…</td>
                        <td>10ç§’</td>
                        <td>10%</td>
                        <td>æ­£åˆ™æå– + å­—å…¸æŸ¥æ‰¾</td>
                    </tr>
                    <tr>
                        <td>æ•°æ®åŠ å¯†</td>
                        <td>20ç§’</td>
                        <td>20%</td>
                        <td>FPE + AEADåŠ å¯†</td>
                    </tr>
                    <tr>
                        <td>å­˜å‚¨å…¥åº“</td>
                        <td>15ç§’</td>
                        <td>15%</td>
                        <td>SHA256 + CAS + SQLite</td>
                    </tr>
                    <tr>
                        <td><strong>æ€»è®¡</strong></td>
                        <td><strong>100ç§’</strong></td>
                        <td><strong>100%</strong></td>
                        <td>çº¦1.7åˆ†é’Ÿ</td>
                    </tr>
                </table>

                <h3>å­˜å‚¨ç»Ÿè®¡</h3>
                <table>
                    <tr>
                        <th>ç±»å‹</th>
                        <th>æ•°é‡</th>
                        <th>å•ä¸ªå¤§å°</th>
                        <th>æ€»å¤§å°</th>
                    </tr>
                    <tr>
                        <td>åŸå§‹DICOM</td>
                        <td>703ä¸ª</td>
                        <td>çº¦500KB</td>
                        <td>350MB</td>
                    </tr>
                    <tr>
                        <td>åŠ å¯†DICOM</td>
                        <td>703ä¸ª</td>
                        <td>çº¦500KB</td>
                        <td>350MB</td>
                    </tr>
                    <tr>
                        <td>åŠ å¯†JSON</td>
                        <td>703ä¸ª</td>
                        <td>çº¦3KB</td>
                        <td>2MB</td>
                    </tr>
                    <tr>
                        <td>CASå­˜å‚¨</td>
                        <td>1406ä¸ª</td>
                        <td>-</td>
                        <td>352MBï¼ˆå»é‡åï¼‰</td>
                    </tr>
                    <tr>
                        <td>SQLiteæ•°æ®åº“</td>
                        <td>703æ¡records</td>
                        <td>-</td>
                        <td>1MB</td>
                    </tr>
                </table>

                <div class="success-box">
                    <strong>âœ… æ€§èƒ½ä¼˜åŒ–æªæ–½</strong><br/>
                    â€¢ åˆ†æ‰¹ä¸Šä¼ ï¼šæ¯æ‰¹100ä¸ªDICOMï¼Œé¿å…å†…å­˜æº¢å‡º<br/>
                    â€¢ å­—å…¸ç´¢å¼•ï¼šO(1)æ—¶é—´å¤æ‚åº¦åŒ¹é…patient_id<br/>
                    â€¢ æ‰¹é‡æ’å…¥ï¼šå‡å°‘æ•°æ®åº“äº‹åŠ¡æ¬¡æ•°<br/>
                    â€¢ CASå»é‡ï¼šç›¸åŒæ–‡ä»¶åªå­˜å‚¨ä¸€æ¬¡
                </div>
            </div>

            <!-- çœŸå®æ•°æ® -->
            <div id="data" class="section">
                <h2>ğŸ“ çœŸå®æ•°æ®ç¤ºä¾‹</h2>

                <h3>æ–‡ä»¶è·¯å¾„æ˜ å°„</h3>
                <table>
                    <tr>
                        <th>é˜¶æ®µ</th>
                        <th>æ–‡ä»¶ç±»å‹</th>
                        <th>çœŸå®è·¯å¾„</th>
                    </tr>
                    <tr>
                        <td>ä¸Šä¼ </td>
                        <td>åŸå§‹CSV</td>
                        <td><code>uploads/csv_91151eea.csv</code></td>
                    </tr>
                    <tr>
                        <td>ä¸Šä¼ </td>
                        <td>åŸå§‹DICOM</td>
                        <td><code>uploads/batch_f68f84bd/patient00001.dcm</code></td>
                    </tr>
                    <tr>
                        <td>ä¿æŠ¤</td>
                        <td>åŠ å¯†DICOM</td>
                        <td><code>output/batch_1761195469190/protected_dicom/patient00001.dcm</code></td>
                    </tr>
                    <tr>
                        <td>ä¿æŠ¤</td>
                        <td>åŠ å¯†JSON</td>
                        <td><code>output/batch_1761195469190/protected_text/patient00001.json</code></td>
                    </tr>
                    <tr>
                        <td>ä¿æŠ¤</td>
                        <td>å®¡è®¡æ¸…å•</td>
                        <td><code>output/batch_1761195469190/protected_text/audit_manifest.json</code></td>
                    </tr>
                    <tr>
                        <td>å­˜å‚¨</td>
                        <td>CAS DICOM</td>
                        <td><code>storage_repo/cas/ab/c123def456789...</code></td>
                    </tr>
                    <tr>
                        <td>å­˜å‚¨</td>
                        <td>CAS JSON</td>
                        <td><code>storage_repo/cas/78/9012abc345678...</code></td>
                    </tr>
                    <tr>
                        <td>å­˜å‚¨</td>
                        <td>SQLite</td>
                        <td><code>storage_repo/db/index.sqlite</code></td>
                    </tr>
                    <tr>
                        <td>å­˜å‚¨</td>
                        <td>æ‰¹æ¬¡å®¡è®¡</td>
                        <td><code>storage_repo/batches/batch_1761195469190/</code></td>
                    </tr>
                </table>

                <h3>CSVæ•°æ®ç¤ºä¾‹ï¼ˆå‰3è¡Œï¼‰</h3>
                <div class="code-block">
                    <pre>
Path,Name,Sex,Age,Phone,ID_Number,Address
data/patient00001/study.dcm,å¼ ä¸‰,Male,35,13812345678,110101199001011234,åŒ—äº¬å¸‚æœé˜³åŒº
data/patient00002/study.dcm,æå››,Female,28,13912345678,310101199501012345,ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº
data/patient00003/study.dcm,ç‹äº”,Male,42,15812345678,440101198001013456,å¹¿å·å¸‚å¤©æ²³åŒº
                    </pre>
                </div>

                <h3>DICOMå…ƒæ•°æ®ç¤ºä¾‹</h3>
                <div class="code-block">
                    <pre>
{
  "filename": "patient00001.dcm",
  "filepath": "uploads/batch_f68f84bd/patient00001.dcm",
  "patient_id": "patient00001",
  "patient_sex": "M",
  "patient_age": "045Y",
  "study_date": "20241021",
  "accession": "ACC123456",
  "institution": "æŸåŒ»é™¢"
}
                    </pre>
                </div>

                <h3>è·¨æ¨¡æ€åŒ¹é…ç»“æœç¤ºä¾‹</h3>
                <div class="code-block">
                    <pre>
{
  "patient_id": "patient00001",
  "row_index": 0,
  "dicom_file": "patient00001.dcm",
  "matched": true,
  "csv_data": {
    "Path": "data/patient00001/study.dcm",
    "Name": "å¼ ä¸‰",
    "Sex": "Male",
    "Age": "35",
    "Phone": "13812345678",
    "ID_Number": "110101199001011234",
    "Address": "åŒ—äº¬å¸‚æœé˜³åŒº"
  },
  "dicom_metadata": {
    "filename": "patient00001.dcm",
    "patient_id": "patient00001",
    "patient_sex": "M",
    "patient_age": "045Y"
  },
  "match_type": "patient_id_exact_match",
  "confidence": 1.0,
  "risk_level": "critical"
}
                    </pre>
                </div>

                <h3>åŠ å¯†JSONç¤ºä¾‹ï¼ˆpatient00001.jsonï¼‰</h3>
                <div class="code-block">
                    <pre>
{
  "dicom_out": "output/batch_1761195469190/protected_dicom/patient00001.dcm",
  "sop": "1.2.840.113619.2.55.3.604688119.868.1234567890.123",
  "assoc": "batch_1761195469190",
  "columns": {
    "patient_id": "QB7RN37E8V2G6",
    "Name": "ZHANGSAN",
    "Sex": "N",
    "Age": "67",
    "Phone": "13812TOKEN"
  },
  "columns_cipher": {
    "patient_id": {
      "token": "QB7RN37E8V2G6",
      "cipher_b64": "YXNjb25fYWVhZF9lbmNyeXB0ZWRfZGF0YQ==",
      "hash": "a1b2c3d4e5f67890abcdef1234567890",
      "ad": "{\"tag\":\"patient_id\",\"sop\":\"1.2.840...\"}",
      "nonce": "1234567890abcdef"
    }
  }
}
                    </pre>
                </div>

                <div class="info-box">
                    <strong>ğŸ” éªŒè¯çœŸå®æ€§</strong><br/>
                    æ‰€æœ‰æ•°æ®éƒ½å¯ä»¥åœ¨é¡¹ç›®ä¸­éªŒè¯ï¼š<br/>
                    <code>ls -l output/batch_1761195469190/protected_dicom/ | wc -l</code> â†’ 703<br/>
                    <code>find storage_repo/cas -type f | wc -l</code> â†’ 1406<br/>
                    <code>python è°ƒè¯•_æ£€æŸ¥æ•°æ®åº“.py</code> â†’ æŸ¥çœ‹SQLiteè®°å½•
                </div>
            </div>
        </div>

        <footer>
            <p><strong>åŒ»ç–—éšç§ä¿æŠ¤ç³»ç»Ÿ</strong> v1.0 | æ•°æ®æµç¨‹å¯è§†åŒ–</p>
            <p>æ‰€æœ‰æ•°æ®åŸºäºçœŸå®ä»£ç å’Œæ–‡ä»¶ | æ‰¹æ¬¡: batch_1761195469190 (703ä¸ªæ–‡ä»¶)</p>
            <p>åˆ›å»ºæ—¶é—´: 2024-10-23 | æŠ€æœ¯æ ˆ: Python + Flask + Ascon + CAS + SQLite</p>
        </footer>
    </div>

    <script>
        // åˆå§‹åŒ–Mermaid
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#667eea',
                primaryTextColor: '#fff',
                primaryBorderColor: '#7b1fa2',
                lineColor: '#6c757d',
                secondaryColor: '#f3e5f5',
                tertiaryColor: '#fce4ec'
            }
        });

        // åˆ‡æ¢ç« èŠ‚
        function showSection(sectionId) {
            // éšè—æ‰€æœ‰ç« èŠ‚
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­ç« èŠ‚
            document.getElementById(sectionId).classList.add('active');

            // æ¿€æ´»å¯¹åº”æŒ‰é’®
            event.target.classList.add('active');

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>

